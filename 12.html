<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Track Me - Combined Dashboard</title>

    <!-- Tailwind CSS CDN -->
    <script src="https://cdn.tailwindcss.com"></script>

    <!-- Google Fonts (Inter & Orbitron for Logo) -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&family=Orbitron:wght@700&display=swap" rel="stylesheet">

    <!-- Lucide Icons -->
    <script src="https://unpkg.com/lucide@latest/dist/umd/lucide.min.js"></script>

    <!-- SheetJS (xlsx) Library for Excel functionality -->
    <script src="https://cdn.sheetjs.com/xlsx-latest/package/dist/xlsx.full.min.js"></script>

    <!-- Chart.js for graphs -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chartjs-adapter-date-fns/dist/chartjs-adapter-date-fns.bundle.min.js"></script>

    <!-- html2canvas and jsPDF for saving reports -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>


    <style>
        body {
            font-family: 'Inter', sans-serif;
            background-color: #F9FAFB; /* A light gray background */
        }
        /* Custom scrollbar for better aesthetics */
        .custom-scrollbar::-webkit-scrollbar {
            width: 8px;
            height: 8px;
        }
        .custom-scrollbar::-webkit-scrollbar-track {
            background: #f1f1f1;
            border-radius: 10px;
        }
        .custom-scrollbar::-webkit-scrollbar-thumb {
            background: #d1d5db;
            border-radius: 10px;
        }
        .custom-scrollbar::-webkit-scrollbar-thumb:hover {
            background: #9ca3af;
        }
        .calendar-day {
            transition: all 0.2s ease-in-out;
        }
        .calendar-day:hover {
            transform: scale(1.1);
            box-shadow: 0 4px 8px rgba(0,0,0,0.1);
        }
        
        /* Preview container for reports inside the modal */
        .a4-page-preview {
            width: 100%;
            background: white;
            position: relative;
            padding: 1rem;
            min-height: 100%; /* Make it fill the scroll container */
        }
        @media (min-width: 640px) {
             .a4-page-preview {
                padding: 1.5rem;
             }
        }
        @media (min-width: 1024px) {
             .a4-page-preview {
                padding: 2.5rem;
             }
        }
        
        /* Fixed-size clone for off-screen rendering for PDF/JPEG */
        .is-rendering-clone {
            width: 210mm;
            /* height property is removed to allow content to define its own height */
            position: absolute;
            top: -9999px;
            left: -9999px;
            z-index: -10;
            background: white;
            padding: 2.5rem;
            margin: 0;
        }

        .report-watermark-bg {
            position: relative;
            background-color: white;
        }

        .report-watermark-bg::before {
            content: "TRACK ME TRACK ME TRACK ME TRACK ME TRACK ME TRACK ME TRACK ME TRACK ME TRACK ME TRACK ME TRACK ME TRACK ME TRACK ME TRACK ME TRACK ME";
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            font-family: 'Orbitron', sans-serif;
            font-size: 5rem;
            font-weight: bold;
            color: rgba(255, 0, 0, 0.08);
            transform: rotate(-45deg) scale(1.5);
            text-align: center;
            line-height: 2.5;
            word-break: break-all;
            pointer-events: none;
            z-index: 1;
        }
        
        /* Animation for the Good Morning Modal */
        @keyframes fadeInScaleUp {
            from {
                opacity: 0;
                transform: scale(0.9);
            }
            to {
                opacity: 1;
                transform: scale(1);
            }
        }
        .fade-in-scale-up {
            animation: fadeInScaleUp 0.5s ease-out forwards;
        }
        
        .gm-item {
             animation: fadeIn 0.5s ease-out forwards;
             opacity: 0;
        }
        
        @keyframes fadeIn {
            to { opacity: 1; }
        }
        
        /* Slider Customization */
        input[type="range"] {
          -webkit-appearance: none;
          appearance: none;
          width: 100%;
          height: 8px;
          border-radius: 5px;
          background: #d1d5db;
          outline: none;
          opacity: 0.7;
          -webkit-transition: .2s;
          transition: opacity .2s;
        }

        input[type="range"]:hover {
          opacity: 1;
        }

        input[type="range"]::-webkit-slider-thumb {
          -webkit-appearance: none;
          appearance: none;
          width: 20px;
          height: 20px;
          border-radius: 50%;
          background: #ef4444; /* Red-500 */
          cursor: pointer;
        }

        input[type="range"]::-moz-range-thumb {
          width: 20px;
          height: 20px;
          border-radius: 50%;
          background: #ef4444; /* Red-500 */
          cursor: pointer;
        }
    </style>
</head>
<body class="text-gray-800 p-4 sm:p-6 lg:p-8">

    <!-- Main App Container -->
    <div class="w-full max-w-7xl mx-auto space-y-6">

        <!-- Top Header -->
        <header class="flex items-center justify-between">
            <div class="flex items-center gap-4">
                 <img id="logo-image" src="" alt="App Logo" class="h-8 hidden"/>
                <span class="text-2xl font-bold text-red-600 tracking-[0.2em]" style="font-family: 'Orbitron', sans-serif;">
                    TRACK ME
                </span>
            </div>
            <div class="flex items-center gap-4">
                <button id="upload-logo-button" class="text-sm font-semibold text-gray-500 uppercase hover:text-red-600 transition-colors flex items-center gap-2">
                     <i data-lucide="upload" class="w-4 h-4"></i>
                     <span>Upload Logo</span>
                </button>
                <input type="file" id="logo-uploader" class="hidden" accept="image/*">
                <button class="text-gray-500 hover:text-gray-800">
                    <i data-lucide="more-vertical" class="w-5 h-5"></i>
                </button>
            </div>
        </header>

        <!-- New Dashboard Section -->
        <div id="app-dashboard" class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-4 gap-4">
            <!-- Productivity Score -->
            <div class="bg-red-50 p-4 rounded-xl shadow flex flex-col justify-between">
                <p class="text-sm font-semibold text-gray-600">Productivity Score</p>
                <div>
                    <p id="productivity-score" class="text-3xl font-bold text-red-600">0%</p>
                    <p id="productivity-tasks" class="text-xs text-gray-500">0/0 Tasks Done</p>
                </div>
            </div>
            <!-- Daily Score -->
            <div class="bg-blue-50 p-4 rounded-xl shadow flex flex-col justify-between">
                <p class="text-sm font-semibold text-gray-600">Today's Score</p>
                 <div>
                    <p id="daily-score-dashboard" class="text-3xl font-bold text-blue-600">0 / 120</p>
                    <p id="daily-score-source" class="text-xs text-gray-500">Based on hourly records</p>
                </div>
            </div>
            <!-- Category Breakdown -->
            <div class="bg-green-50 p-4 rounded-xl shadow">
                <p class="text-sm font-semibold text-gray-600">Category Breakdown</p>
                <div class="flex justify-between items-center mt-2">
                    <span class="text-xs font-medium">Personal / Home</span>
                    <span id="category-personal-count" class="text-xs font-bold">0/0</span>
                </div>
                <div class="w-full bg-gray-200 rounded-full h-1.5 mt-1">
                    <div id="category-personal-bar" class="bg-green-500 h-1.5 rounded-full" style="width: 0%"></div>
                </div>
                <div class="flex justify-between items-center mt-2">
                    <span class="text-xs font-medium">Office / Work</span>
                    <span id="category-office-count" class="text-xs font-bold">0/0</span>
                </div>
                <div class="w-full bg-gray-200 rounded-full h-1.5 mt-1">
                    <div id="category-office-bar" class="bg-blue-500 h-1.5 rounded-full" style="width: 0%"></div>
                </div>
            </div>
            <!-- Priority Distribution -->
            <div class="bg-yellow-50 p-4 rounded-xl shadow">
                <p class="text-sm font-semibold text-gray-600">Priority Distribution</p>
                <div class="flex justify-between items-center mt-2">
                    <span class="text-xs font-medium">High</span>
                    <span id="priority-high-count" class="text-xs font-bold">0/0</span>
                </div>
                <div class="w-full bg-gray-200 rounded-full h-1.5 mt-1">
                    <div id="priority-high-bar" class="bg-red-500 h-1.5 rounded-full" style="width: 0%"></div>
                </div>
                 <div class="flex justify-between items-center mt-2">
                    <span class="text-xs font-medium">Medium</span>
                    <span id="priority-medium-count" class="text-xs font-bold">0/0</span>
                </div>
                <div class="w-full bg-gray-200 rounded-full h-1.5 mt-1">
                    <div id="priority-medium-bar" class="bg-yellow-500 h-1.5 rounded-full" style="width: 0%"></div>
                </div>
            </div>
        </div>

        <!-- Quick Actions Grid -->
        <div class="grid grid-cols-2 sm:grid-cols-4 gap-4">
             <div id="finance-button" class="bg-red-50 text-red-800 p-3 rounded-lg flex flex-col items-center justify-center text-center space-y-2 hover:bg-red-100 cursor-pointer transition-colors">
                <i data-lucide="circle-dollar-sign" class="w-6 h-6"></i>
                <span class="text-xs font-semibold">Finance</span>
            </div>
             <div id="marking-button" class="bg-red-50 text-red-800 p-3 rounded-lg flex flex-col items-center justify-center text-center space-y-2 hover:bg-red-100 cursor-pointer transition-colors">
                <i data-lucide="calendar-check" class="w-6 h-6"></i>
                <span class="text-xs font-semibold">End of Day Marking</span>
            </div>
            <div id="work-plan-button" class="bg-red-50 text-red-800 p-3 rounded-lg flex flex-col items-center justify-center text-center space-y-2 hover:bg-red-100 cursor-pointer transition-colors">
                <i data-lucide="bar-chart-2" class="w-6 h-6"></i>
                <span class="text-xs font-semibold">Work Plan</span>
            </div>
            <div id="report-button" class="bg-red-50 text-red-800 p-3 rounded-lg flex flex-col items-center justify-center text-center space-y-2 hover:bg-red-100 cursor-pointer transition-colors">
                <i data-lucide="lightbulb" class="w-6 h-6"></i>
                <span class="text-xs font-semibold">Report</span>
            </div>
        </div>

        <!-- Main Content Grid -->
        <div class="grid grid-cols-1 md:grid-cols-3 gap-6">
            <!-- Calendar and Actions -->
            <div class="md:col-span-2 space-y-6">
                <!-- Calendar -->
                <div id="calendar" class="bg-white p-4 rounded-xl shadow"></div>

                <!-- Action Buttons -->
                <div class="flex flex-col md:flex-row items-center gap-4">
                     <button id="reset-app-btn" title="Reset All Data" class="bg-yellow-400 text-gray-800 p-3 rounded-lg hover:bg-yellow-500 transition-colors">
                        <i data-lucide="trash-2" class="w-6 h-6"></i>
                    </button>
                    <div class="w-full flex flex-col sm:flex-row gap-4">
                         <button id="download-xlsx" class="w-full bg-red-600 text-white font-bold py-3 rounded-lg hover:bg-red-700 transition-colors">DOWNLOAD AS XLSX</button>
                         <button id="upload-xlsx" class="w-full bg-red-600 text-white font-bold py-3 rounded-lg hover:bg-red-700 transition-colors">UPLOAD XLSX</button>
                         <input type="file" id="xlsx-uploader" class="hidden" accept=".xlsx, .xls">
                    </div>
                </div>
            </div>

            <!-- Status Column -->
            <div class="bg-white rounded-xl shadow overflow-hidden">
                <div class="bg-red-700 text-white font-bold p-3 text-center">
                    Work Schedule<span id="work-schedule-header-date"> for Today</span>
                </div>
                <div id="status-list" class="p-4 space-y-3 bg-gray-50 h-96 overflow-y-auto custom-scrollbar">
                    <!-- Status Items will be dynamically loaded here -->
                </div>
            </div>
        </div>

        <!-- NEW Task Health Dashboard -->
        <div id="task-health-dashboard" class="bg-white p-4 sm:p-6 rounded-xl shadow space-y-4">
            <div class="flex justify-between items-center">
                <h3 class="text-xl font-bold text-gray-800">Today's Health & Productivity Analysis</h3>
                 <i data-lucide="heart-pulse" class="w-6 h-6 text-red-500"></i>
            </div>
            <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
                <!-- Left Column - Charts -->
                <div class="space-y-6">
                    <div>
                        <h4 class="font-semibold text-gray-600 mb-2 text-sm">Life Balance (Work vs Screen Time)</h4>
                        <canvas id="balance-chart" class="w-full h-48"></canvas>
                    </div>
                    <div>
                        <h4 class="font-semibold text-gray-600 mb-2 text-sm">Well-being Trends (Mood, Stress, Self-Control)</h4>
                         <canvas id="wellbeing-chart" class="w-full h-48"></canvas>
                    </div>
                </div>
                <!-- Right Column - Stats -->
                <div class="grid grid-cols-2 gap-4">
                     <div class="bg-blue-50 p-3 rounded-lg flex flex-col justify-center items-center text-center">
                         <p class="text-sm font-semibold text-blue-800">Water Intake</p>
                         <p id="health-water-intake" class="text-2xl font-bold text-blue-700">0 L</p>
                         <p class="text-xs text-gray-500">Goal: 2.5L</p>
                     </div>
                     <div class="bg-green-50 p-3 rounded-lg flex flex-col justify-center items-center text-center">
                         <p class="text-sm font-semibold text-green-800">Workout</p>
                         <p id="health-workout-time" class="text-2xl font-bold text-green-700">0 h</p>
                          <p class="text-xs text-gray-500">Goal: 0.5h</p>
                     </div>
                     <div class="bg-yellow-50 p-3 rounded-lg flex flex-col justify-center items-center text-center col-span-2">
                         <p class="text-sm font-semibold text-yellow-800">Task Completion Trend</p>
                          <p id="health-task-completion" class="text-2xl font-bold text-yellow-700">0%</p>
                          <p class="text-xs text-gray-500">Latest record</p>
                     </div>
                      <div class="bg-purple-50 p-3 rounded-lg flex flex-col justify-center items-center text-center col-span-2">
                         <p class="text-sm font-semibold text-purple-800">Food Quality</p>
                          <div id="health-food-quality" class="flex gap-2 mt-2">
                              <!-- Icons will be injected here -->
                          </div>
                     </div>
                </div>
            </div>
        </div>


        <!-- Dashboard Analysis Section -->
        <div id="dashboard-analysis-section" class="bg-white p-4 sm:p-6 rounded-xl shadow space-y-4">
            <div class="flex flex-col sm:flex-row justify-between items-center gap-2">
                <h3 class="text-lg sm:text-xl font-bold text-gray-800 text-center sm:text-left">Dashboard Analysis for <span id="analysis-month-name" class="text-red-600"></span></h3>
                <div class="flex items-center gap-2">
                    <button id="prev-month-btn" title="Previous Month" class="p-2 rounded-full hover:bg-gray-100 transition-colors"><i data-lucide="chevron-left" class="w-5 h-5"></i></button>
                    <button id="next-month-btn" title="Next Month" class="p-2 rounded-full hover:bg-gray-100 transition-colors"><i data-lucide="chevron-right" class="w-5 h-5"></i></button>
                </div>
            </div>
            <!-- Tabs -->
            <div class="border-b border-gray-200">
                <nav class="-mb-px flex space-x-4 sm:space-x-6 overflow-x-auto custom-scrollbar pb-1" aria-label="Tabs">
                    <button class="analysis-tab whitespace-nowrap py-3 px-1 border-b-2 font-medium text-sm text-red-600 border-red-500" data-tab="finance-summary">Finance Summary</button>
                    <button class="analysis-tab whitespace-nowrap py-3 px-1 border-b-2 font-medium text-sm text-gray-500 border-transparent hover:text-gray-700 hover:border-gray-300" data-tab="work-plan-insights">Work Plan Insights</button>
                    <button class="analysis-tab whitespace-nowrap py-3 px-1 border-b-2 font-medium text-sm text-gray-500 border-transparent hover:text-gray-700 hover:border-gray-300" data-tab="health-summary">Monthly Health Score</button>
                </nav>
            </div>

            <!-- Tab Content -->
            <div>
                <!-- Finance Summary Content -->
                <div id="finance-summary-content" class="analysis-tab-content space-y-4">
                    <div class="grid grid-cols-1 md:grid-cols-3 gap-4 text-center">
                        <div class="bg-green-50 p-3 rounded-lg"><p class="text-sm text-green-800 font-semibold">Total Income (<span class="analysis-month-label">Month</span>)</p><p id="finance-summary-income" class="text-2xl font-bold text-green-700">0</p></div>
                        <div class="bg-red-50 p-3 rounded-lg"><p class="text-sm text-red-800 font-semibold">Total Expense (<span class="analysis-month-label">Month</span>)</p><p id="finance-summary-expense" class="text-2xl font-bold text-red-700">0</p></div>
                        <div class="bg-blue-50 p-3 rounded-lg"><p class="text-sm text-blue-800 font-semibold">Net Savings (<span class="analysis-month-label">Month</span>)</p><p id="finance-summary-net" class="text-2xl font-bold text-blue-700">0</p></div>
                    </div>
                    <div>
                        <canvas id="finance-line-chart" class="w-full h-64"></canvas>
                    </div>
                </div>

                <!-- Work Plan Insights Content -->
                <div id="work-plan-insights-content" class="analysis-tab-content hidden space-y-4">
                     <div class="grid grid-cols-1 md:grid-cols-3 gap-4 text-center">
                        <div class="bg-purple-50 p-3 rounded-lg"><p class="text-sm text-purple-800 font-semibold">Completion (<span class="analysis-month-label">Month</span>)</p><p id="work-plan-summary-completion" class="text-2xl font-bold text-purple-700">0%</p></div>
                        <div class="bg-yellow-50 p-3 rounded-lg"><p class="text-sm text-yellow-800 font-semibold">Busiest Day (<span class="analysis-month-label">Month</span>)</p><p id="work-plan-summary-busiest" class="text-2xl font-bold text-yellow-700">N/A</p></div>
                        <div class="bg-indigo-50 p-3 rounded-lg"><p class="text-sm text-indigo-800 font-semibold">Total Tasks (<span class="analysis-month-label">Month</span>)</p><p id="work-plan-summary-total" class="text-2xl font-bold text-indigo-700">0</p></div>
                    </div>
                    <div class="grid grid-cols-1 lg:grid-cols-2 gap-6 items-center">
                         <div><canvas id="work-plan-bar-chart" class="w-full h-64"></canvas></div>
                         <div><canvas id="work-plan-doughnut-chart" class="w-full h-64"></canvas></div>
                    </div>
                </div>
                
                <!-- Health Summary Content -->
                 <div id="health-summary-content" class="analysis-tab-content hidden space-y-4">
                     <div class="text-center">
                         <p class="text-sm text-gray-600 font-semibold">Average Health Score (<span class="analysis-month-label">Month</span>)</p>
                         <p id="health-summary-avg-score" class="text-4xl font-bold text-red-600">0 / 120</p>
                     </div>
                     <div class="max-w-md mx-auto">
                        <canvas id="health-radar-chart" class="w-full h-64 sm:h-80"></canvas>
                     </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Good Morning Modal -->
    <div id="good-morning-modal" class="fixed inset-0 bg-black bg-opacity-70 z-50 flex items-center justify-center p-4 hidden">
        <div id="good-morning-content" class="bg-white rounded-2xl shadow-2xl w-full max-w-4xl max-h-[90vh] flex flex-col fade-in-scale-up">
            <!-- Header -->
            <div class="p-4 border-b flex justify-between items-center bg-gray-50 rounded-t-2xl">
                <div>
                    <h2 class="text-2xl font-bold text-gray-800">Good Morning, <span id="gm-user-name"></span>!</h2>
                    <p class="text-gray-500 text-sm">Here's your daily briefing for <span id="gm-today-date"></span>.</p>
                </div>
                <button id="close-gm-modal" class="text-gray-500 hover:text-red-600 p-2 rounded-full"><i data-lucide="x" class="w-6 h-6"></i></button>
            </div>
            <!-- Body -->
            <div id="gm-body" class="p-6 flex-grow overflow-y-auto custom-scrollbar space-y-6">
                <!-- Content will be injected by JS -->
            </div>
        </div>
    </div>


    <!-- User Info Modal -->
    <div id="user-info-modal" class="fixed inset-0 bg-black bg-opacity-60 z-50 flex items-center justify-center p-4 hidden">
        <div class="bg-white rounded-xl shadow-2xl p-6 w-full max-w-sm text-center">
            <h2 class="text-xl font-bold mb-2">Welcome!</h2>
            <p class="text-gray-600 mb-6">Please enter your details to get started.</p>
            <div class="space-y-4">
                <input id="user-name" type="text" placeholder="Your Name" class="w-full border border-gray-300 rounded-lg px-4 py-2 focus:outline-none focus:ring-2 focus:ring-red-500 transition-colors">
                <input id="user-mobile" type="tel" placeholder="Mobile Number" class="w-full border border-gray-300 rounded-lg px-4 py-2 focus:outline-none focus:ring-2 focus:ring-red-500 transition-colors">
            </div>
            <button id="save-user-info" class="w-full bg-red-600 text-white font-bold py-3 rounded-lg hover:bg-red-700 transition-colors mt-6">Save & Continue</button>
        </div>
    </div>

    <!-- Finance Modal -->
    <div id="finance-modal" class="fixed inset-0 bg-black bg-opacity-60 z-40 flex items-center justify-center p-4 hidden">
        <div class="bg-white rounded-xl shadow-2xl w-full max-w-4xl h-[90vh] flex flex-col">
            <!-- Modal Header -->
            <div class="p-4 border-b flex justify-between items-center">
                <h2 class="text-xl font-bold text-gray-800">Finance Details</h2>
                <button id="close-finance-modal" class="text-gray-500 hover:text-red-600 p-2 rounded-full"><i data-lucide="x" class="w-5 h-5"></i></button>
            </div>
            <!-- Modal Body -->
            <div class="p-4 flex-grow overflow-y-auto custom-scrollbar">
                <!-- Tabs -->
                <div class="flex border-b mb-4">
                    <button data-tab="transactions" class="finance-tab py-2 px-4 font-semibold text-red-600 border-b-2 border-red-600">Daily Transactions</button>
                    <button data-tab="borrowers" class="finance-tab py-2 px-4 font-semibold text-gray-500">Borrowers</button>
                    <button data-tab="forecast" class="finance-tab py-2 px-4 font-semibold text-gray-500">Forecast</button>
                </div>
                <!-- Transactions Content -->
                <div id="transactions-content" class="finance-tab-content space-y-4">
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                        <!-- Cash In Form -->
                        <div class="bg-gray-50 p-4 rounded-lg border">
                            <h3 class="font-bold text-green-600 mb-2">Cash In</h3>
                            <div class="space-y-3">
                                <input type="date" id="transaction-date" class="w-full bg-white border-gray-300 rounded-md shadow-sm">
                                <input type="number" id="cash-in-amount" placeholder="Amount" class="w-full border-gray-300 rounded-md shadow-sm">
                                <input type="text" id="cash-in-purpose" placeholder="Purpose (e.g., Salary)" list="cash-in-purposes" class="w-full border-gray-300 rounded-md shadow-sm">
                                <datalist id="cash-in-purposes"></datalist>
                                <select id="cash-in-source" class="w-full border-gray-300 rounded-md shadow-sm">
                                    <option>BKash</option><option>Rocket</option><option>Nagad</option><option>Bank Acc.</option><option>Cash</option>
                                </select>
                                <button id="save-cash-in" class="w-full bg-green-600 text-white font-bold py-2 rounded-md hover:bg-green-700 transition">Add Income</button>
                            </div>
                        </div>
                        <!-- Expense Form -->
                        <div class="bg-gray-50 p-4 rounded-lg border">
                            <h3 class="font-bold text-red-600 mb-2">Expense</h3>
                             <div class="space-y-3">
                                <input type="number" id="expense-amount" placeholder="Amount" class="w-full border-gray-300 rounded-md shadow-sm">
                                <input type="text" id="expense-purpose" placeholder="Purpose (e.g., Groceries)" list="expense-purposes" class="w-full border-gray-300 rounded-md shadow-sm">
                                <datalist id="expense-purposes"></datalist>
                                <select id="expense-source" class="w-full border-gray-300 rounded-md shadow-sm">
                                     <option>BKash</option><option>Rocket</option><option>Nagad</option><option>Bank Acc.</option><option>Cash</option>
                                </select>
                                <button id="save-expense" class="w-full bg-red-600 text-white font-bold py-2 rounded-md hover:bg-red-700 transition">Add Expense</button>
                            </div>
                        </div>
                    </div>
                    <!-- Transactions List -->
                    <div>
                        <h4 class="font-bold mt-4">Transactions for <span id="selected-date-display"></span></h4>
                        <div id="daily-transactions-list" class="mt-2 space-y-2 h-48 overflow-y-auto custom-scrollbar p-1"></div>
                    </div>
                </div>
                <!-- Borrowers Content -->
                <div id="borrowers-content" class="finance-tab-content hidden space-y-4">
                     <div class="bg-gray-50 p-4 rounded-lg border">
                         <h3 class="font-bold text-blue-600 mb-2">Add New Borrower</h3>
                         <div class="grid grid-cols-1 sm:grid-cols-2 md:grid-cols-3 gap-3">
                             <input type="date" id="borrower-date" class="border-gray-300 rounded-md shadow-sm" title="Date">
                             <input type="number" id="borrower-amount" placeholder="Amount" class="border-gray-300 rounded-md shadow-sm">
                             <input type="text" id="borrower-name" placeholder="Borrower Name" class="border-gray-300 rounded-md shadow-sm">
                             <input type="text" id="lender-name" placeholder="Lender Name" class="border-gray-300 rounded-md shadow-sm">
                             <input type="date" id="borrower-commit-date" class="border-gray-300 rounded-md shadow-sm" title="Committed Date">
                             <input type="date" id="borrower-followup-date" class="border-gray-300 rounded-md shadow-sm" title="Follow-up Date">
                         </div>
                         <button id="save-borrower" class="mt-3 w-full bg-blue-600 text-white font-bold py-2 rounded-md hover:bg-blue-700 transition">Save Borrower</button>
                     </div>
                     <div class="h-64 overflow-x-auto custom-scrollbar">
                         <table class="w-full text-sm text-left">
                             <thead class="bg-gray-100 sticky top-0"><tr><th class="p-2">Borrower</th><th class="p-2">Amount</th><th class="p-2">Commit Date</th><th class="p-2">Status</th></tr></thead>
                             <tbody id="borrowers-list"></tbody>
                         </table>
                     </div>
                </div>
                <!-- Forecast Content -->
                <div id="forecast-content" class="finance-tab-content hidden space-y-4">
                    <div class="bg-gray-50 p-4 rounded-lg border">
                        <h3 class="font-bold text-gray-700 mb-2">Set Forecast for a Week</h3>
                        <div class="space-y-3">
                            <div>
                                <label class="text-sm font-medium">Select any day of the week:</label>
                                <input type="date" id="forecast-date-picker" class="w-full bg-white border-gray-300 rounded-md shadow-sm mt-1">
                            </div>
                            <p class="text-center font-semibold text-red-600 bg-red-50 p-2 rounded-md">Selected Week: <span id="forecast-week-range"></span></p>
                            <input type="number" id="forecast-cash-in" placeholder="Forecasted Cash In" class="w-full border-gray-300 rounded-md shadow-sm">
                            <input type="number" id="forecast-expense" placeholder="Forecasted Expense" class="w-full border-gray-300 rounded-md shadow-sm">
                            <button id="save-forecast" class="w-full bg-red-600 text-white font-bold py-2 rounded-md hover:bg-red-700 transition">Save Week Forecast</button>
                        </div>
                    </div>
                    <div class="h-48 overflow-y-auto custom-scrollbar border rounded-lg p-2">
                        <h4 class="font-bold text-gray-700 mb-2 sticky top-0 bg-white pb-2">Saved Forecasts</h4>
                        <div id="forecast-list" class="space-y-2"></div>
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Notepad Modal for Large Transactions -->
    <div id="notepad-modal" class="fixed inset-0 bg-black bg-opacity-60 z-[51] flex items-center justify-center p-4 hidden">
        <div class="bg-white rounded-xl shadow-2xl p-6 w-full max-w-md">
            <h2 class="text-xl font-bold mb-2">Add Note for Large Transaction</h2>
            <p class="text-gray-500 mb-4">Please provide a reason for this transaction of <span id="notepad-amount" class="font-bold"></span> BDT.</p>
            <input type="hidden" id="notepad-transaction-id">
            <textarea id="notepad-input" rows="4" class="w-full border-gray-300 rounded-md shadow-sm focus:ring-red-500 focus:border-red-500" placeholder="Enter reason here..."></textarea>
            <div class="flex justify-end gap-4 mt-4">
                <button id="cancel-notepad-btn" class="bg-gray-400 text-white font-bold py-2 px-6 rounded-lg hover:bg-gray-500 transition">Skip</button>
                <button id="save-notepad-btn" class="bg-red-600 text-white font-bold py-2 px-6 rounded-lg hover:bg-red-700 transition">Save Note</button>
            </div>
        </div>
    </div>

    <!-- Note Display Modal -->
    <div id="note-display-modal" class="fixed inset-0 bg-black bg-opacity-60 z-[52] flex items-center justify-center p-4 hidden">
        <div class="bg-white rounded-xl shadow-2xl p-6 w-full max-w-md">
            <div class="flex justify-between items-center mb-4">
                <h2 class="text-xl font-bold">Transaction Note</h2>
                <button id="close-note-display-modal" class="text-gray-500 hover:text-red-600 p-2 rounded-full"><i data-lucide="x"></i></button>
            </div>
            <div id="note-display-content" class="bg-gray-50 p-4 rounded-md border text-gray-700 whitespace-pre-wrap"></div>
        </div>
    </div>

    <!-- Commitment Alert Modal -->
    <div id="commitment-alert-modal" class="fixed inset-0 bg-black bg-opacity-70 z-50 flex items-center justify-center p-4 hidden">
        <div class="bg-white rounded-xl shadow-2xl p-6 w-full max-w-md text-center">
            <i data-lucide="alert-triangle" class="mx-auto h-12 w-12 text-yellow-500"></i>
            <h2 class="text-xl font-bold mt-4">Commitment Date Due</h2>
            <div id="commitment-alert-details" class="text-gray-600 my-4 bg-gray-50 p-3 rounded-md"></div>
            <p class="text-gray-700 mb-6">Has the borrowed amount been paid?</p>
            <div class="flex justify-center gap-4">
                <button id="commitment-paid-btn" class="bg-green-600 text-white font-bold py-2 px-6 rounded-lg hover:bg-green-700 transition">Yes, Paid</button>
                <button id="commitment-reschedule-btn" class="bg-yellow-500 text-white font-bold py-2 px-6 rounded-lg hover:bg-yellow-600 transition">No, Reschedule</button>
                <button id="commitment-later-btn" class="bg-gray-400 text-white font-bold py-2 px-6 rounded-lg hover:bg-gray-500 transition">Later</button>
            </div>
        </div>
    </div>

    <!-- Reschedule Modal -->
     <div id="reschedule-modal" class="fixed inset-0 bg-black bg-opacity-70 z-50 flex items-center justify-center p-4 hidden">
        <div class="bg-white rounded-xl shadow-2xl p-6 w-full max-w-sm text-center">
            <h2 class="text-xl font-bold mb-4">Reschedule Date</h2>
            <p id="reschedule-borrower-name" class="text-gray-600 mb-4"></p>
            <div>
                <label class="text-sm font-medium">New Committed Date:</label>
                <input type="date" id="new-commit-date" class="w-full bg-white border-gray-300 rounded-md shadow-sm mt-1">
            </div>
            <div class="flex justify-center gap-4 mt-6">
                <button id="save-reschedule-btn" class="bg-blue-600 text-white font-bold py-2 px-6 rounded-lg hover:bg-blue-700 transition">Save</button>
                <button id="cancel-reschedule-btn" class="bg-gray-400 text-white font-bold py-2 px-6 rounded-lg hover:bg-gray-500 transition">Cancel</button>
            </div>
        </div>
    </div>
    
    <!-- Date Range Report Modals -->
    <div id="report-segment-choice-modal" class="fixed inset-0 bg-black bg-opacity-60 z-50 flex items-center justify-center p-4 hidden">
        <div class="bg-white rounded-xl shadow-2xl p-6 w-full max-w-md">
             <div class="flex justify-between items-center mb-4">
                <h2 class="text-xl font-bold">Select Segment for Custom Report</h2>
                <button id="close-report-segment-choice-modal" class="text-gray-500 hover:text-red-600 p-2 rounded-full"><i data-lucide="x"></i></button>
            </div>
            <div class="grid grid-cols-1 sm:grid-cols-3 gap-4">
                 <button data-segment="Finance" class="report-segment-btn bg-red-50 text-red-800 p-3 rounded-lg flex flex-col items-center justify-center text-center space-y-2 hover:bg-red-100 cursor-pointer transition-colors">
                    <i data-lucide="circle-dollar-sign" class="w-6 h-6"></i><span class="text-xs font-semibold">Finance</span>
                </button>
                 <button data-segment="Marking" class="report-segment-btn bg-blue-50 text-blue-800 p-3 rounded-lg flex flex-col items-center justify-center text-center space-y-2 hover:bg-blue-100 cursor-pointer transition-colors">
                    <i data-lucide="calendar-check" class="w-6 h-6"></i><span class="text-xs font-semibold">Marking</span>
                </button>
                 <button data-segment="Work Plan" class="report-segment-btn bg-green-50 text-green-800 p-3 rounded-lg flex flex-col items-center justify-center text-center space-y-2 hover:bg-green-100 cursor-pointer transition-colors">
                    <i data-lucide="bar-chart-2" class="w-6 h-6"></i><span class="text-xs font-semibold">Work Plan</span>
                </button>
            </div>
        </div>
    </div>

    <div id="date-range-report-modal" class="fixed inset-0 bg-black bg-opacity-60 z-50 flex items-center justify-center p-4 hidden">
        <div class="bg-white rounded-xl shadow-2xl p-6 w-full max-w-2xl">
            <div class="flex justify-between items-center mb-4">
                <h2 id="date-range-report-title" class="text-xl font-bold"></h2>
                <button id="close-date-range-report-modal" class="text-gray-500 hover:text-red-600 p-2 rounded-full"><i data-lucide="x"></i></button>
            </div>
            <div class="space-y-4">
                <div class="bg-gray-50 p-4 rounded-lg border flex flex-col sm:flex-row items-center gap-4">
                    <input type="date" id="report-start-date" class="w-full border-gray-300 rounded-md shadow-sm">
                    <span class="text-gray-500">to</span>
                    <input type="date" id="report-end-date" class="w-full border-gray-300 rounded-md shadow-sm">
                    <button id="generate-range-report-btn" class="w-full sm:w-auto bg-red-600 text-white font-bold py-2 px-6 rounded-lg hover:bg-red-700 transition">Generate</button>
                </div>
                <div id="range-report-content" class="max-h-[60vh] overflow-y-auto custom-scrollbar"></div>
            </div>
        </div>
    </div>
    
    <!-- Comprehensive Report Modal -->
    <div id="comprehensive-report-modal" class="fixed inset-0 bg-black bg-opacity-60 z-[51] flex items-center justify-center p-4 hidden">
         <!-- This modal content is now dynamically generated in JS -->
    </div>
    
    <!-- Calendar Date Action Modal -->
    <div id="calendar-date-action-modal" class="fixed inset-0 bg-black bg-opacity-60 z-50 flex items-center justify-center p-4 hidden">
        <div class="bg-white rounded-xl shadow-2xl p-6 w-full max-w-md">
             <div class="flex justify-between items-center mb-4">
                <h2 class="text-xl font-bold">Actions for <span id="calendar-action-date"></span></h2>
                <button id="close-calendar-action-modal" class="text-gray-500 hover:text-red-600 p-2 rounded-full"><i data-lucide="x"></i></button>
            </div>
            <p class="text-gray-500 mb-6">Select a segment to view the detailed report for this day.</p>
            <div class="grid grid-cols-1 sm:grid-cols-3 gap-4">
                 <button data-segment="Finance" class="calendar-action-segment-btn bg-red-50 text-red-800 p-3 rounded-lg flex flex-col items-center justify-center text-center space-y-2 hover:bg-red-100 cursor-pointer transition-colors">
                    <i data-lucide="circle-dollar-sign" class="w-6 h-6"></i><span class="text-xs font-semibold">Finance</span>
                </button>
                 <button data-segment="Marking" class="calendar-action-segment-btn bg-blue-50 text-blue-800 p-3 rounded-lg flex flex-col items-center justify-center text-center space-y-2 hover:bg-blue-100 cursor-pointer transition-colors">
                    <i data-lucide="calendar-check" class="w-6 h-6"></i><span class="text-xs font-semibold">Marking</span>
                </button>
                 <button data-segment="Work Plan" class="calendar-action-segment-btn bg-green-50 text-green-800 p-3 rounded-lg flex flex-col items-center justify-center text-center space-y-2 hover:bg-green-100 cursor-pointer transition-colors">
                    <i data-lucide="bar-chart-2" class="w-6 h-6"></i><span class="text-xs font-semibold">Work Plan</span>
                </button>
            </div>
        </div>
    </div>


    <!-- Marking Modal -->
    <div id="marking-modal" class="fixed inset-0 bg-gray-900 bg-opacity-50 z-50 flex items-center justify-center p-4 hidden">
        <div class="bg-white rounded-lg shadow-xl w-full max-w-2xl max-h-full overflow-y-auto">
            <!-- Modal Header -->
            <div class="flex justify-between items-center p-4 border-b">
                <div class="flex items-center gap-4">
                    <h3 class="text-xl font-semibold">End of Day Summary</h3>
                    <input type="date" id="marking-date-picker" class="border-gray-300 rounded-md shadow-sm focus:ring-red-500 focus:border-red-500 sm:text-sm">
                </div>
                <button id="close-modal-button" class="text-gray-400 hover:text-gray-600 p-2 rounded-full">
                    <i data-lucide="x" class="w-5 h-5"></i>
                </button>
            </div>
            <!-- Modal Body -->
            <div class="p-6">
                 <p class="text-sm text-gray-600 mb-4 bg-yellow-50 border-l-4 border-yellow-400 p-3 rounded-r-lg">This section is for your end-of-day summary. Hourly records are collected automatically via popups. Data entered here will be combined with hourly records for the final daily score.</p>
                <form id="marking-form" class="grid grid-cols-1 md:grid-cols-2 gap-x-6 gap-y-4">
                    <!-- Input fields -->
                    <div>
                        <label for="sleep-duration" class="block text-sm font-medium text-gray-700">Sleep Duration (Hours)</label>
                        <input type="number" id="sleep-duration" class="marking-input mt-1 block w-full border-gray-300 rounded-md shadow-sm focus:ring-red-500 focus:border-red-500 sm:text-sm" placeholder="e.g., 8">
                    </div>
                    <div>
                        <label for="prayer-count" class="block text-sm font-medium text-gray-700">Namaz / Prayer Count</label>
                        <input type="number" id="prayer-count" min="0" max="5" class="marking-input mt-1 block w-full border-gray-300 rounded-md shadow-sm focus:ring-red-500 focus:border-red-500 sm:text-sm" placeholder="e.g., 5">
                    </div>
                    <div>
                        <label for="overall-rating" class="block text-sm font-medium text-gray-700">Overall Day Rating (1-10)</label>
                        <select id="overall-rating" class="marking-input mt-1 block w-full border-gray-300 rounded-md shadow-sm focus:ring-red-500 focus:border-red-500 sm:text-sm">
                           <option>1</option><option>2</option><option>3</option><option>4</option><option>5</option><option>6</option><option>7</option><option>8</option><option>9</option><option>10</option>
                        </select>
                    </div>
                </form>
            </div>
             <!-- Modal Footer -->
            <div class="flex justify-between items-center p-4 border-t bg-gray-50 rounded-b-lg">
                <div>
                    <span class="font-semibold">Final Daily Score:</span>
                    <span id="total-score" class="font-bold text-lg text-red-600">0 / 120</span>
                </div>
                <button id="save-marking-button" class="bg-red-600 text-white font-semibold py-2 px-6 rounded-lg shadow hover:bg-red-700 transition-colors focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-red-500">
                    Save Summary
                </button>
            </div>
        </div>
    </div>
    
    <!-- 3-Hour Record Reminder Modal -->
    <div id="record-reminder-modal" class="fixed inset-0 bg-black bg-opacity-70 z-[55] flex items-center justify-center p-4 hidden">
        <div class="bg-white rounded-lg shadow-xl w-full max-w-lg max-h-full overflow-y-auto custom-scrollbar">
             <div class="flex justify-between items-center p-4 border-b bg-gray-50">
                <h3 id="reminder-title" class="text-xl font-semibold text-gray-800">Quick Check-in</h3>
                <button id="close-reminder-modal" class="text-gray-400 hover:text-gray-600 p-2 rounded-full">
                    <i data-lucide="x" class="w-5 h-5"></i>
                </button>
            </div>
            <div class="p-6">
                <form id="reminder-form" class="grid grid-cols-1 md:grid-cols-2 gap-x-6 gap-y-4">
                    <!-- Food -->
                    <div class="md:col-span-2 grid grid-cols-1 sm:grid-cols-2 gap-4">
                        <div>
                            <label class="block text-sm font-medium text-gray-700">Did you eat?</label>
                            <select id="reminder-food-taken" class="mt-1 block w-full border-gray-300 rounded-md shadow-sm">
                                <option>No</option>
                                <option>Yes</option>
                            </select>
                        </div>
                        <div id="reminder-food-quality-container" class="hidden">
                             <label class="block text-sm font-medium text-gray-700">Food Quality</label>
                            <select id="reminder-food-quality" class="mt-1 block w-full border-gray-300 rounded-md shadow-sm">
                                <option>Healthy</option>
                                <option>Normal</option>
                                <option>Junk</option>
                            </select>
                        </div>
                    </div>
                    <!-- Water -->
                    <div>
                        <label for="reminder-water" class="block text-sm font-medium text-gray-700">Water Intake (glasses)</label>
                        <input type="number" id="reminder-water" class="mt-1 block w-full border-gray-300 rounded-md shadow-sm" placeholder="e.g., 2">
                        <p id="reminder-water-liters" class="text-xs text-gray-500 mt-1">~ 0.0 Liters</p>
                    </div>
                    <!-- Workout -->
                    <div>
                        <label for="reminder-workout" class="block text-sm font-medium text-gray-700">Workout (hours)</label>
                        <input type="number" step="0.1" id="reminder-workout" class="mt-1 block w-full border-gray-300 rounded-md shadow-sm" placeholder="e.g., 0.5">
                    </div>
                     <!-- Work Hours -->
                    <div>
                        <label for="reminder-work" class="block text-sm font-medium text-gray-700">Work (hours)</label>
                        <input type="number" step="0.1" id="reminder-work" class="mt-1 block w-full border-gray-300 rounded-md shadow-sm" placeholder="e.g., 3">
                    </div>
                    <!-- Screen Time -->
                     <div>
                        <label for="reminder-screen" class="block text-sm font-medium text-gray-700">Screen Time (hours)</label>
                        <input type="number" step="0.1" id="reminder-screen" class="mt-1 block w-full border-gray-300 rounded-md shadow-sm" placeholder="e.g., 1">
                    </div>
                    <!-- Self Control -->
                     <div>
                        <label class="block text-sm font-medium text-gray-700">Self-Control</label>
                        <select id="reminder-self-control" class="mt-1 block w-full border-gray-300 rounded-md shadow-sm">
                           <option>1</option><option>2</option><option>3</option><option>4</option><option>5</option><option>6</option><option>7</option><option>8</option><option>9</option><option>10</option>
                        </select>
                    </div>
                     <!-- Stress Level -->
                    <div>
                        <label class="block text-sm font-medium text-gray-700">Stress Level</label>
                        <select id="reminder-stress" class="mt-1 block w-full border-gray-300 rounded-md shadow-sm">
                           <option>1</option><option>2</option><option>3</option><option>4</option><option>5</option><option>6</option><option>7</option><option>8</option><option>9</option><option>10</option>
                        </select>
                    </div>
                     <!-- Mood Level -->
                    <div>
                        <label class="block text-sm font-medium text-gray-700">Mood Level</label>
                        <select id="reminder-mood" class="mt-1 block w-full border-gray-300 rounded-md shadow-sm">
                           <option>1</option><option>2</option><option>3</option><option>4</option><option>5</option><option>6</option><option>7</option><option>8</option><option>9</option><option>10</option>
                        </select>
                    </div>
                    <!-- Task Completion -->
                     <div class="md:col-span-2">
                        <label for="reminder-tasks" class="block text-sm font-medium text-gray-700">Task Completion</label>
                        <input type="range" id="reminder-tasks" min="0" max="100" value="50" class="mt-1 w-full h-2 bg-gray-200 rounded-lg appearance-none cursor-pointer">
                        <p class="text-center text-sm font-semibold text-gray-600 mt-1"><span id="reminder-tasks-value">50</span>%</p>
                    </div>
                </form>
            </div>
             <div class="flex justify-end p-4 border-t bg-gray-50">
                <button id="save-reminder-button" class="bg-red-600 text-white font-semibold py-2 px-6 rounded-lg shadow hover:bg-red-700 transition-colors">
                    Save Record
                </button>
            </div>
        </div>
    </div>


    <!-- Work Plan Modal -->
    <div id="work-plan-modal" class="fixed inset-0 bg-gray-900 bg-opacity-50 z-50 flex items-center justify-center p-4 hidden">
        <div class="bg-white rounded-lg shadow-xl w-full max-w-6xl h-[95vh] flex flex-col">
            <!-- Modal Header -->
            <div class="flex justify-between items-center p-4 border-b sticky top-0 bg-white z-10">
                <div class="flex items-center gap-4">
                    <h3 class="text-xl font-semibold">Daily Planner</h3>
                    <input type="date" id="work-plan-date-picker" class="border-gray-300 rounded-md shadow-sm focus:ring-red-500 focus:border-red-500 sm:text-sm">
                </div>
                <button id="close-work-plan-modal" class="text-gray-400 hover:text-gray-600 p-2 rounded-full">
                    <i data-lucide="x" class="w-5 h-5"></i>
                </button>
            </div>
            <!-- Modal Body -->
            <div id="daily-planner-content" class="p-4 flex-grow overflow-y-auto custom-scrollbar">
                <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4">
                    <!-- Time Segments -->
                    <div class="space-y-4">
                        <div class="bg-blue-50 border border-blue-200 rounded-lg p-3">
                            <h4 class="font-bold text-blue-800">Morning (6-10 AM)</h4>
                            <div id="segment-morning-office" class="mt-2 space-y-2"></div>
                            <div id="segment-morning-personal" class="mt-2 space-y-2"></div>
                            <button class="add-task-btn mt-2 text-sm text-blue-600 hover:underline" data-segment="morning">+ Add Task</button>
                        </div>
                        <div class="bg-yellow-50 border border-yellow-200 rounded-lg p-3">
                            <h4 class="font-bold text-yellow-800">Midday (10 AM-2 PM)</h4>
                            <div id="segment-midday-office" class="mt-2 space-y-2"></div>
                            <div id="segment-midday-personal" class="mt-2 space-y-2"></div>
                            <button class="add-task-btn mt-2 text-sm text-yellow-600 hover:underline" data-segment="midday">+ Add Task</button>
                        </div>
                    </div>
                    <div class="space-y-4">
                        <div class="bg-orange-50 border border-orange-200 rounded-lg p-3">
                            <h4 class="font-bold text-orange-800">Afternoon (2-6 PM)</h4>
                            <div id="segment-afternoon-office" class="mt-2 space-y-2"></div>
                            <div id="segment-afternoon-personal" class="mt-2 space-y-2"></div>
                            <button class="add-task-btn mt-2 text-sm text-orange-600 hover:underline" data-segment="afternoon">+ Add Task</button>
                        </div>
                        <div class="bg-purple-50 border border-purple-200 rounded-lg p-3">
                            <h4 class="font-bold text-purple-800">Evening (6-9 PM)</h4>
                            <div id="segment-evening-office" class="mt-2 space-y-2"></div>
                            <div id="segment-evening-personal" class="mt-2 space-y-2"></div>
                            <button class="add-task-btn mt-2 text-sm text-purple-600 hover:underline" data-segment="evening">+ Add Task</button>
                        </div>
                    </div>
                    <div class="space-y-4">
                        <div class="bg-indigo-50 border border-indigo-200 rounded-lg p-3">
                            <h4 class="font-bold text-indigo-800">Night (9-11 PM)</h4>
                            <div id="segment-night-office" class="mt-2 space-y-2"></div>
                            <div id="segment-night-personal" class="mt-2 space-y-2"></div>
                            <button class="add-task-btn mt-2 text-sm text-indigo-600 hover:underline" data-segment="night">+ Add Task</button>
                        </div>
                        <div class="bg-gray-50 border border-gray-200 rounded-lg p-3">
                            <h4 class="font-bold text-gray-800">Late Night (11 PM - 3 AM)</h4>
                            <div id="segment-latenight-office" class="mt-2 space-y-2"></div>
                            <div id="segment-latenight-personal" class="mt-2 space-y-2"></div>
                            <button class="add-task-btn mt-2 text-sm text-gray-600 hover:underline" data-segment="latenight">+ Add Task</button>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Add/Edit Task Modal -->
    <div id="task-modal" class="fixed inset-0 bg-black bg-opacity-60 z-[51] flex items-center justify-center p-4 hidden">
        <div class="bg-white rounded-xl shadow-2xl p-6 w-full max-w-md">
            <h2 id="task-modal-title" class="text-xl font-bold mb-4">Add New Task</h2>
            <div class="space-y-4">
                <input type="hidden" id="task-id">
                <input type="hidden" id="task-segment">
                
                <div>
                    <label class="text-sm font-medium">Category</label>
                    <select id="task-category" class="w-full border-gray-300 rounded-md shadow-sm mt-1">
                        <option>Office / Work</option>
                        <option>Personal / Home</option>
                    </select>
                </div>
                <div>
                    <label class="text-sm font-medium">Task Name</label>
                    <input id="task-name" type="text" placeholder="Enter task name" class="w-full border-gray-300 rounded-md shadow-sm mt-1">
                </div>
                <div class="grid grid-cols-2 gap-4">
                    <div>
                        <label class="text-sm font-medium">Priority</label>
                        <select id="task-priority" class="w-full border-gray-300 rounded-md shadow-sm mt-1">
                            <option>High</option><option>Medium</option><option>Low</option>
                        </select>
                    </div>
                    <div>
                         <label class="text-sm font-medium">Time</label>
                        <input id="task-time" type="time" class="w-full border-gray-300 rounded-md shadow-sm mt-1">
                    </div>
                </div>
                <div>
                    <label class="text-sm font-medium">Status</label>
                    <select id="task-status" class="w-full border-gray-300 rounded-md shadow-sm mt-1">
                        <option>Planned</option>
                        <option>In Progress</option>
                        <option>Done</option>
                        <option>Skipped</option>
                        <option>Moved</option>
                    </select>
                </div>
                <div id="task-moved-container" class="hidden grid grid-cols-1 sm:grid-cols-2 gap-4">
                    <div>
                        <label class="text-sm font-medium">New Date</label>
                        <input id="task-moved-date" type="date" class="w-full border-gray-300 rounded-md shadow-sm mt-1">
                    </div>
                    <div>
                        <label class="text-sm font-medium">New Time</label>
                        <input id="task-moved-time" type="time" class="w-full border-gray-300 rounded-md shadow-sm mt-1">
                    </div>
                </div>
                <div>
                    <label class="text-sm font-medium">Notes</label>
                    <textarea id="task-notes" rows="3" class="w-full border-gray-300 rounded-md shadow-sm mt-1"></textarea>
                </div>
            </div>
            <div class="flex justify-end gap-4 mt-6">
                 <button id="delete-task-btn" class="bg-red-600 text-white font-bold py-2 px-6 rounded-lg hover:bg-red-700 transition hidden">Delete</button>
                <button id="cancel-task-btn" class="bg-gray-400 text-white font-bold py-2 px-6 rounded-lg hover:bg-gray-500 transition">Cancel</button>
                <button id="save-task-btn" class="bg-blue-600 text-white font-bold py-2 px-6 rounded-lg hover:bg-blue-700 transition">Save Task</button>
            </div>
        </div>
    </div>


    <!-- Toast Notification -->
    <div id="toast-notification" class="fixed bottom-5 right-5 bg-green-600 text-white py-3 px-5 rounded-lg shadow-lg hidden transition-opacity duration-300">
        <!-- Message here -->
    </div>

    <!-- Delete Confirmation Modal -->
    <div id="delete-confirm-modal" class="fixed inset-0 bg-black bg-opacity-70 z-50 flex items-center justify-center p-4 hidden">
        <div class="bg-white rounded-xl shadow-2xl p-6 w-full max-w-sm text-center">
            <i data-lucide="trash-2" class="mx-auto h-12 w-12 text-red-500"></i>
            <h2 class="text-xl font-bold mt-4">Delete All Data?</h2>
            <p class="text-gray-600 my-4">Are you sure you want to permanently delete all your records? This action cannot be undone.</p>
            <div class="flex justify-center gap-4">
                <button id="cancel-delete-btn" class="bg-gray-400 text-white font-bold py-2 px-6 rounded-lg hover:bg-gray-500 transition">Cancel</button>
                <button id="confirm-delete-btn" class="bg-red-600 text-white font-bold py-2 px-6 rounded-lg hover:bg-red-700 transition">Yes, Delete</button>
            </div>
        </div>
    </div>


    <script>
    document.addEventListener("DOMContentLoaded", () => {
        // --- App Initial State ---
        let financeTransactions = [];
        let financeBorrowers = [];
        let workPlanData = {};
        let financeForecasts = [];
        let markingHistory = {};
        let hourlyRecords = {}; // New: For 3-hourly popups
        let currentBorrowerForAction = null;
        let selectedDateForSchedule = null;
        let chartInstances = {}; // Store all chart instances
        let analysisDate = new Date(); // Date for the analysis dashboard view
        let reminderInterval = null; // To hold the setInterval for the reminder

        // --- Core Functions ---
        const saveData = (key, data) => localStorage.setItem(key, JSON.stringify(data));
        const loadData = (key, defaultValue = []) => {
            try {
                const storedValue = localStorage.getItem(key);
                if (storedValue && (storedValue.startsWith('[') || storedValue.startsWith('{'))) {
                    return JSON.parse(storedValue);
                }
                return defaultValue;
            } catch (error) {
                console.error(`Error parsing localStorage key "${key}":`, error);
                localStorage.removeItem(key);
                return defaultValue;
            }
        };

        // NEW: Helper function to get local date in YYYY-MM-DD format
        const localDateToYYYYMMDD = (date) => {
            const year = date.getFullYear();
            const month = String(date.getMonth() + 1).padStart(2, '0');
            const day = String(date.getDate()).padStart(2, '0');
            return `${year}-${month}-${day}`;
        };


        // --- Modals Logic ---
        const modals = {
            'finance-modal': { open: document.getElementById('finance-button'), close: document.getElementById('close-finance-modal') },
            'marking-modal': { open: document.getElementById('marking-button'), close: document.getElementById('close-modal-button') },
            'work-plan-modal': { open: document.getElementById('work-plan-button'), close: document.getElementById('close-work-plan-modal') },
            'task-modal': { open: null, close: document.getElementById('cancel-task-btn')},
            'user-info-modal': { open: null, close: document.getElementById('save-user-info') },
            'commitment-alert-modal': { open: null, close: document.getElementById('commitment-later-btn') },
            'reschedule-modal': { open: null, close: document.getElementById('cancel-reschedule-btn') },
            'report-segment-choice-modal': { open: document.getElementById('report-button'), close: document.getElementById('close-report-segment-choice-modal') },
            'date-range-report-modal': { open: null, close: document.getElementById('close-date-range-report-modal') },
            'calendar-date-action-modal': { open: null, close: document.getElementById('close-calendar-action-modal') },
            'notepad-modal': { open: null, close: document.getElementById('cancel-notepad-btn') },
            'note-display-modal': { open: null, close: document.getElementById('close-note-display-modal') },
            'good-morning-modal': { open: null, close: document.getElementById('close-gm-modal') },
            'record-reminder-modal': { open: null, close: document.getElementById('close-reminder-modal') },
        };

        const setupModals = () => {
            for (const modalId in modals) {
                const modalEl = document.getElementById(modalId);
                if (!modalEl) continue;
                const { open, close } = modals[modalId];
                if (open) open.addEventListener('click', () => {
                     if (modalId === 'marking-modal') {
                        const today = todayDate.toISOString().split('T')[0];
                        document.getElementById('marking-date-picker').value = today;
                        loadMarkingData(today); 
                     } else if (modalId === 'work-plan-modal') {
                        const today = todayDate.toISOString().split('T')[0];
                        document.getElementById('work-plan-date-picker').value = today;
                        renderWorkPlan(today);
                     }
                     modalEl.classList.remove('hidden');
                });
                if (close) close.addEventListener('click', () => modalEl.classList.add('hidden'));
            }
        };
        
        // --- Finance Module: Daily Transactions & Borrowers ---
        const transactionDateInput = document.getElementById('transaction-date');

        const renderTransactionsForDate = (dateStr) => {
            document.getElementById('selected-date-display').textContent = dateStr;
            const listEl = document.getElementById('daily-transactions-list');
            listEl.innerHTML = '';
            const filtered = financeTransactions.filter(t => t.date === dateStr);
            if (filtered.length === 0) {
                listEl.innerHTML = '<p class="text-gray-500 text-center py-4">No transactions for this day.</p>';
                return;
            }
            filtered.forEach(t => {
                const isIncome = t.type === 'income';
                const textColor = isIncome ? 'text-green-600' : 'text-red-600';
                const sign = isIncome ? '+' : '-';
                const div = document.createElement('div');
                div.className = "flex justify-between items-center bg-white p-2 rounded-md shadow-sm border-l-4 " + (isIncome ? "border-green-400" : "border-red-400");
                div.innerHTML = `
                    <div>
                        <p class="font-semibold">${t.purpose}</p>
                        <p class="text-xs text-gray-500">${t.source}</p>
                    </div>
                    <div class="flex items-center gap-2">
                        ${t.note ? `<i data-lucide="sticky-note" class="w-4 h-4 text-blue-500 cursor-pointer view-note-btn" data-transaction-id="${t.id}"></i>` : ''}
                        <p class="font-bold ${textColor}">${sign}${t.amount} BDT</p>
                    </div>`;
                listEl.appendChild(div);
            });
            lucide.createIcons();
        };
        
        transactionDateInput.addEventListener('change', () => renderTransactionsForDate(transactionDateInput.value));

        const updatePurposeDatalists = () => {
            const incomePurposes = [...new Set(financeTransactions.filter(t => t.type === 'income').map(t => t.purpose))];
            const expensePurposes = [...new Set(financeTransactions.filter(t => t.type === 'expense').map(t => t.purpose))];
            document.getElementById('cash-in-purposes').innerHTML = incomePurposes.map(p => `<option value="${p}">`).join('');
            document.getElementById('expense-purposes').innerHTML = expensePurposes.map(p => `<option value="${p}">`).join('');
        };

        document.getElementById('save-cash-in').addEventListener('click', () => {
            const newIncome = {
                id: Date.now(),
                date: transactionDateInput.value,
                type: 'income',
                amount: document.getElementById('cash-in-amount').value,
                purpose: document.getElementById('cash-in-purpose').value,
                source: document.getElementById('cash-in-source').value,
                note: ''
            };
            if (!newIncome.date || !newIncome.amount || !newIncome.purpose) { alert('Please fill all income fields.'); return; }
            financeTransactions.push(newIncome);
            saveData('financeTransactions', financeTransactions);
            renderTransactionsForDate(newIncome.date);
            updatePurposeDatalists();

            if (parseFloat(newIncome.amount) >= 2000) {
                openNotepadModal(newIncome.id, newIncome.amount);
            }

            document.getElementById('cash-in-amount').value = '';
            document.getElementById('cash-in-purpose').value = '';
        });

        document.getElementById('save-expense').addEventListener('click', () => {
            const newExpense = {
                id: Date.now(),
                date: transactionDateInput.value,
                type: 'expense',
                amount: document.getElementById('expense-amount').value,
                purpose: document.getElementById('expense-purpose').value,
                source: document.getElementById('expense-source').value,
                note: ''
            };
            if (!newExpense.date || !newExpense.amount || !newExpense.purpose) { alert('Please fill all expense fields.'); return; }
            financeTransactions.push(newExpense);
            saveData('financeTransactions', financeTransactions);
            renderTransactionsForDate(newExpense.date);
            updatePurposeDatalists();

            if (parseFloat(newExpense.amount) >= 2000) {
                openNotepadModal(newExpense.id, newExpense.amount);
            }

            document.getElementById('expense-amount').value = '';
            document.getElementById('expense-purpose').value = '';
        });

        const renderBorrowers = () => {
            const listEl = document.getElementById('borrowers-list');
            listEl.innerHTML = '';
            financeBorrowers.forEach(b => {
                let statusClass = 'bg-yellow-100 text-yellow-800'; // Pending
                if (b.status === 'Paid') statusClass = 'bg-green-100 text-green-800';
                if (b.status === 'Rescheduled') statusClass = 'bg-purple-100 text-purple-800';

                const row = document.createElement('tr');
                row.className = 'border-b hover:bg-gray-50';
                row.innerHTML = `
                    <td class="p-2 font-semibold">${b.name}</td>
                    <td class="p-2">${b.amount} BDT</td>
                    <td class="p-2">${b.commitDate}</td>
                    <td class="p-2"><span class="px-2 py-1 text-xs font-semibold rounded-full ${statusClass}">${b.status}</span></td>`;
                listEl.appendChild(row);
            });
        };

        document.getElementById('save-borrower').addEventListener('click', () => {
            const newBorrower = {
                id: Date.now(),
                date: document.getElementById('borrower-date').value,
                amount: document.getElementById('borrower-amount').value,
                name: document.getElementById('borrower-name').value,
                lender: document.getElementById('lender-name').value,
                commitDate: document.getElementById('borrower-commit-date').value,
                followUp: document.getElementById('borrower-followup-date').value,
                status: 'Pending'
            };
            if (!newBorrower.name || !newBorrower.amount || !newBorrower.commitDate) { alert('Please fill Name, Amount and Committed Date.'); return; }
            financeBorrowers.push(newBorrower);
            saveData('financeBorrowers', financeBorrowers);
            renderBorrowers();
            ['borrower-date', 'borrower-amount', 'borrower-name', 'lender-name', 'borrower-commit-date', 'borrower-followup-date'].forEach(id => document.getElementById(id).value = '');
        });

        document.querySelectorAll('.finance-tab').forEach(tab => {
            tab.addEventListener('click', (e) => {
                const tabName = e.currentTarget.dataset.tab;
                document.querySelectorAll('.finance-tab').forEach(t => {
                    t.classList.remove('text-red-600', 'border-red-600');
                    t.classList.add('text-gray-500');
                });
                e.currentTarget.classList.add('text-red-600', 'border-red-600');
                e.currentTarget.classList.remove('text-gray-500');
                document.querySelectorAll('.finance-tab-content').forEach(c => c.classList.add('hidden'));
                document.getElementById(`${tabName}-content`).classList.remove('hidden');
            });
        });

        // --- Notepad for Large Transactions ---
        const openNotepadModal = (transactionId, amount) => {
            document.getElementById('notepad-transaction-id').value = transactionId;
            document.getElementById('notepad-amount').textContent = amount;
            document.getElementById('notepad-input').value = '';
            document.getElementById('notepad-modal').classList.remove('hidden');
        };

        document.getElementById('save-notepad-btn').addEventListener('click', () => {
            const transactionId = parseInt(document.getElementById('notepad-transaction-id').value);
            const note = document.getElementById('notepad-input').value;
            const transaction = financeTransactions.find(t => t.id === transactionId);
            if (transaction) {
                transaction.note = note;
                saveData('financeTransactions', financeTransactions);
                renderTransactionsForDate(transaction.date); // Re-render to show the note icon
                showToast('Note saved!');
            }
            document.getElementById('notepad-modal').classList.add('hidden');
        });

        // --- View Note ---
        document.getElementById('daily-transactions-list').addEventListener('click', (e) => {
            if (e.target.classList.contains('view-note-btn') || e.target.closest('.view-note-btn')) {
                const button = e.target.closest('.view-note-btn');
                const transactionId = parseInt(button.dataset.transactionId);
                const transaction = financeTransactions.find(t => t.id === transactionId);
                if (transaction && transaction.note) {
                    document.getElementById('note-display-content').textContent = transaction.note;
                    document.getElementById('note-display-modal').classList.remove('hidden');
                }
            }
        });
        
        // --- Borrower Commitment Alerts ---
        const checkBorrowerCommitments = () => {
            const today = localDateToYYYYMMDD(todayDate);
            const dueBorrower = financeBorrowers.find(b => b.commitDate && (b.status === 'Pending' || b.status === 'Rescheduled') && b.commitDate <= today);
            if(dueBorrower) {
                currentBorrowerForAction = dueBorrower;
                document.getElementById('commitment-alert-details').innerHTML = `
                    <strong>${dueBorrower.name}</strong> owes <strong>${dueBorrower.amount} BDT</strong>.
                    <br>Committed date was <strong>${dueBorrower.commitDate}</strong>.`;
                document.getElementById('commitment-alert-modal').classList.remove('hidden');
            }
        };

        document.getElementById('commitment-paid-btn').addEventListener('click', () => {
            if(currentBorrowerForAction) {
                const borrower = financeBorrowers.find(b => b.id === currentBorrowerForAction.id);
                borrower.status = 'Paid';
                saveData('financeBorrowers', financeBorrowers);
                renderBorrowers();
                document.getElementById('commitment-alert-modal').classList.add('hidden');
                currentBorrowerForAction = null;
                setTimeout(checkBorrowerCommitments, 500); // Check for next one
            }
        });

        document.getElementById('commitment-reschedule-btn').addEventListener('click', () => {
            if(currentBorrowerForAction) {
                document.getElementById('reschedule-borrower-name').textContent = `Rescheduling for ${currentBorrowerForAction.name}`;
                document.getElementById('commitment-alert-modal').classList.add('hidden');
                document.getElementById('reschedule-modal').classList.remove('hidden');
            }
        });

        document.getElementById('save-reschedule-btn').addEventListener('click', () => {
            const newDate = document.getElementById('new-commit-date').value;
            if(currentBorrowerForAction && newDate) {
                 const borrower = financeBorrowers.find(b => b.id === currentBorrowerForAction.id);
                 borrower.commitDate = newDate;
                 borrower.status = 'Rescheduled';
                 saveData('financeBorrowers', financeBorrowers);
                 renderBorrowers();
                 document.getElementById('reschedule-modal').classList.add('hidden');
                 currentBorrowerForAction = null;
                 setTimeout(checkBorrowerCommitments, 500); // Check for next one
            } else {
                alert('Please select a new date.');
            }
        });


        // --- Forecast Module ---
        const forecastDatePicker = document.getElementById('forecast-date-picker');
        const forecastWeekRangeEl = document.getElementById('forecast-week-range');
        const forecastListEl = document.getElementById('forecast-list');

        const getWeekRange = (date) => {
            date = new Date(date);
            const day = date.getDay();
            const diff = date.getDate() - day;
            const startOfWeek = new Date(new Date(date).setDate(diff));
            const endOfWeek = new Date(new Date(date).setDate(diff + 6));
            const formatDate = (d) => d.toISOString().split('T')[0];
            return { start: formatDate(startOfWeek), end: formatDate(endOfWeek) };
        };

        const updateForecastWeekRange = () => {
            const range = getWeekRange(forecastDatePicker.value);
            forecastWeekRangeEl.textContent = `${range.start} to ${range.end}`;
        };

        const renderForecasts = () => {
            forecastListEl.innerHTML = '';
            financeForecasts.sort((a, b) => (a.weekStart > b.weekStart) ? 1 : -1);
            financeForecasts.forEach(f => {
                const div = document.createElement('div');
                div.className = 'bg-white p-2 rounded-md shadow-sm border';
                div.innerHTML = `
                    <p class="font-bold">${f.weekStart} to ${f.weekEnd}</p>
                    <div class="flex justify-between text-sm mt-1">
                        <p class="text-green-600">Income: ${f.cashIn} BDT</p>
                        <p class="text-red-600">Expense: ${f.expense} BDT</p>
                    </div>
                `;
                forecastListEl.appendChild(div);
            });
        };

        forecastDatePicker.addEventListener('change', updateForecastWeekRange);
        
        document.getElementById('save-forecast').addEventListener('click', () => {
            const { start, end } = getWeekRange(forecastDatePicker.value);
            const newForecast = {
                id: Date.now(),
                weekStart: start,
                weekEnd: end,
                cashIn: document.getElementById('forecast-cash-in').value || 0,
                expense: document.getElementById('forecast-expense').value || 0,
            };
            financeForecasts = financeForecasts.filter(f => f.weekStart !== start);
            financeForecasts.push(newForecast);
            saveData('financeForecasts', financeForecasts);
            renderForecasts();
             document.getElementById('forecast-cash-in').value = '';
             document.getElementById('forecast-expense').value = '';
        });

        // --- Marking Module (New Automated System) ---
        const markingDatePicker = document.getElementById('marking-date-picker');
        const totalScoreEl = document.getElementById('total-score');
        
        const calculateDailyScore = (date) => {
            const manualData = markingHistory[date] || {};
            const hourlyData = hourlyRecords[date] || {};

            let aggregated = {
                sleep: parseFloat(manualData.sleep) || 0,
                prayer: parseInt(manualData.prayer) || 0,
                overall: parseInt(manualData.overall) || 0,
                food: [],
                water: 0, workout: 0, work: 0, screen: 0,
                selfControl: [], stress: [], mood: [], tasks: []
            };

            Object.values(hourlyData).forEach(rec => {
                if (rec.food && rec.food !== 'N/A') aggregated.food.push(rec.food);
                aggregated.water += parseFloat(rec.water) || 0;
                aggregated.workout += parseFloat(rec.workout) || 0;
                aggregated.work += parseFloat(rec.work) || 0;
                aggregated.screen += parseFloat(rec.screen) || 0;
                aggregated.selfControl.push(parseInt(rec.selfControl) || 0);
                aggregated.stress.push(parseInt(rec.stress) || 0);
                aggregated.mood.push(parseInt(rec.mood) || 0);
                aggregated.tasks.push(parseInt(rec.tasks) || 0);
            });

            let totalPoints = 0;
            // Manual entries
            if (aggregated.sleep >= 7 && aggregated.sleep <= 8) totalPoints += 10; else if (aggregated.sleep >= 5 && aggregated.sleep < 7) totalPoints += 5;
            if (aggregated.prayer === 5) totalPoints += 10; else if (aggregated.prayer >= 3) totalPoints += 7; else if (aggregated.prayer >= 1) totalPoints += 4;
            totalPoints += aggregated.overall;

            // Aggregated hourly entries
            const avg = arr => arr.length ? arr.reduce((a, b) => a + b, 0) / arr.length : 0;
            const foodScore = avg(aggregated.food.map(f => ({'Healthy': 10, 'Normal': 7, 'Junk': 3}[f] || 0)));
            totalPoints += foodScore;
            
            if (aggregated.water >= 2.5) totalPoints += 10; else if (aggregated.water >= 1.5) totalPoints += 7; else if (aggregated.water >= 1) totalPoints += 4;
            if (aggregated.workout >= 0.5) totalPoints += 10; else if (aggregated.workout >= 0.2) totalPoints += 5; // 0.5hr = 30min
            
            const avgSelfControl = avg(aggregated.selfControl);
            totalPoints += avgSelfControl;
            
            const avgStress = avg(aggregated.stress);
            if(avgStress > 0) totalPoints += (11 - avgStress);

            if (aggregated.work >= 6 && aggregated.work <= 8) totalPoints += 10; else if (aggregated.work >= 4) totalPoints += 7; else if (aggregated.work > 0) totalPoints += 4;
            
            const lastTaskCompletion = aggregated.tasks.length ? aggregated.tasks[aggregated.tasks.length - 1] : 0;
            totalPoints += (lastTaskCompletion / 10);
            
            if (aggregated.screen > 0 && aggregated.screen <= 4) totalPoints += 10; else if (aggregated.screen <= 6) totalPoints += 7; else if (aggregated.screen <= 8) totalPoints += 4;
            
            const avgMood = avg(aggregated.mood);
            totalPoints += avgMood;

            return Math.round(totalPoints * 10) / 10;
        };

        const showToast = (message) => {
            const toast = document.getElementById('toast-notification');
            toast.textContent = message;
            toast.classList.remove('hidden');
            setTimeout(() => toast.classList.add('hidden'), 3000);
        };

        const saveMarkingData = () => {
            const selectedDate = markingDatePicker.value;
            const data = {
                sleep: document.getElementById('sleep-duration').value,
                prayer: document.getElementById('prayer-count').value,
                overall: document.getElementById('overall-rating').value,
            };
            markingHistory[selectedDate] = data;
            saveData('markingHistory', markingHistory);
            
            const finalScore = calculateDailyScore(selectedDate);
            totalScoreEl.textContent = `${finalScore} / 120`;
            
            showToast('End of day summary saved!');
            document.getElementById('marking-modal').classList.add('hidden');
            renderAppDashboard();
        };

        const loadMarkingData = (dateStr) => {
            const data = markingHistory[dateStr] || {};
            document.getElementById('sleep-duration').value = data.sleep || '';
            document.getElementById('prayer-count').value = data.prayer || '';
            document.getElementById('overall-rating').value = data.overall || '1';
            
            const finalScore = calculateDailyScore(dateStr);
            totalScoreEl.textContent = `${finalScore} / 120`;
        };

        document.getElementById('save-marking-button').addEventListener('click', saveMarkingData);
        document.querySelectorAll('#marking-modal .marking-input').forEach(input => input.addEventListener('input', () => {
             const finalScore = calculateDailyScore(markingDatePicker.value);
             totalScoreEl.textContent = `${finalScore} / 120`;
        }));
        markingDatePicker.addEventListener('change', () => loadMarkingData(markingDatePicker.value));

        // --- NEW: 3-Hour Reminder Logic ---
        const checkRecordReminder = () => {
            const now = new Date();
            const todayStr = localDateToYYYYMMDD(todayDate);
            const currentHour = now.getHours();
            const currentMinutes = now.getMinutes();

            // Don't show if a modal is already open
            const reminderModal = document.getElementById('record-reminder-modal');
            if (!reminderModal.classList.contains('hidden')) {
                return;
            }
            
            if (!hourlyRecords[todayStr]) {
                hourlyRecords[todayStr] = {};
            }

            // Special Case: Final check-in for the day
            if (currentHour === 23 && currentMinutes >= 30) {
                const finalSlot = 21; // The 9 PM slot
                if (!hourlyRecords[todayStr][finalSlot]) {
                    reminderModal.dataset.slot = finalSlot;
                    document.getElementById('reminder-title').textContent = `Quick Check-in (21:00 - 00:00)`;
                    reminderModal.classList.remove('hidden');
                }
                return; // Stop further checks for today
            }

            // Normal Case: Check for the previous 3-hour block
            const currentSlot = Math.floor(currentHour / 3) * 3;
            const slotToCheck = currentSlot - 3;

            if (slotToCheck < 0) {
                return; // No previous slot to check for today
            }

            if (!hourlyRecords[todayStr][slotToCheck]) {
                const slotStart = slotToCheck;
                const slotEnd = slotToCheck + 3;
                
                reminderModal.dataset.slot = slotToCheck;
                document.getElementById('reminder-title').textContent = `Quick Check-in (${slotStart}:00 - ${slotEnd}:00)`;
                reminderModal.classList.remove('hidden');
            }
        };

        // Reminder Form Interactions
        document.getElementById('reminder-food-taken').addEventListener('change', (e) => {
            document.getElementById('reminder-food-quality-container').classList.toggle('hidden', e.target.value === 'No');
        });
        document.getElementById('reminder-water').addEventListener('input', (e) => {
            const glasses = parseFloat(e.target.value) || 0;
            document.getElementById('reminder-water-liters').textContent = `~ ${(glasses * 0.2).toFixed(1)} Liters`;
        });
        document.getElementById('reminder-tasks').addEventListener('input', (e) => {
            document.getElementById('reminder-tasks-value').textContent = e.target.value;
        });
        
        document.getElementById('save-reminder-button').addEventListener('click', () => {
            const todayStr = localDateToYYYYMMDD(todayDate);
            const reminderModal = document.getElementById('record-reminder-modal');
            const slotToSave = reminderModal.dataset.slot; // Retrieve the stored slot

            if (slotToSave === undefined) {
                console.error("Could not determine which slot to save the record for.");
                return;
            }
            
            const slotStart = parseInt(slotToSave);
            const slotEnd = slotStart + 3;

            const foodTaken = document.getElementById('reminder-food-taken').value;
            const record = {
                food: foodTaken === 'Yes' ? document.getElementById('reminder-food-quality').value : 'N/A',
                water: (parseFloat(document.getElementById('reminder-water').value) || 0) * 0.2,
                workout: document.getElementById('reminder-workout').value || 0,
                work: document.getElementById('reminder-work').value || 0,
                screen: document.getElementById('reminder-screen').value || 0,
                selfControl: document.getElementById('reminder-self-control').value,
                stress: document.getElementById('reminder-stress').value,
                mood: document.getElementById('reminder-mood').value,
                tasks: document.getElementById('reminder-tasks').value,
            };
            
            if (!hourlyRecords[todayStr]) hourlyRecords[todayStr] = {};
            hourlyRecords[todayStr][slotToSave] = record;
            
            saveData('hourlyRecords', hourlyRecords);
            showToast(`Record for ${slotStart}:00 - ${slotEnd}:00 saved!`);
            document.getElementById('record-reminder-modal').classList.add('hidden');
            document.getElementById('reminder-form').reset();
            // Trigger dashboard updates
            renderAppDashboard();
            renderTaskHealthDashboard();
        });


        // --- Work Plan Module ---
        const workPlanDatePicker = document.getElementById('work-plan-date-picker');
        
        const getSegmentFromTime = (time) => {
            if (!time) return 'morning'; // Default segment
            const [hour] = time.split(':').map(Number);
            if (hour >= 6 && hour < 10) return 'morning';
            if (hour >= 10 && hour < 14) return 'midday';
            if (hour >= 14 && hour < 18) return 'afternoon';
            if (hour >= 18 && hour < 21) return 'evening';
            if (hour >= 21 && hour < 23) return 'night';
            return 'latenight';
        }

        const renderWorkPlan = (date) => {
            const tasks = workPlanData[date] || [];
            document.querySelectorAll('[id^="segment-"]').forEach(el => el.innerHTML = '');

            tasks.forEach(task => {
                const segment = getSegmentFromTime(task.time);
                const category = task.category.includes('Office') ? 'office' : 'personal';
                const containerId = `segment-${segment}-${category}`;
                const container = document.getElementById(containerId);

                if(container) {
                    const priorityClasses = { 'High': 'border-red-500', 'Medium': 'border-yellow-500', 'Low': 'border-green-500' };
                    const taskEl = document.createElement('div');
                    taskEl.className = `bg-white p-2 rounded-md shadow-sm border-l-4 ${priorityClasses[task.priority]} text-xs cursor-pointer hover:shadow-md transition-shadow`;
                    taskEl.dataset.taskId = task.id;
                    taskEl.innerHTML = `
                        <p class="font-bold">${task.name}</p>
                        <p class="text-gray-500">${task.time} - ${task.status}</p>
                    `;
                    taskEl.addEventListener('click', () => openTaskModal(task));
                    container.appendChild(taskEl);
                }
            });
        };
        
        document.querySelectorAll('.add-task-btn').forEach(btn => {
            btn.addEventListener('click', (e) => {
                const segment = e.target.dataset.segment;
                openTaskModal(null, segment);
            });
        });

        const openTaskModal = (task = null, segment = null) => {
            const modal = document.getElementById('task-modal');
            document.getElementById('task-modal-title').textContent = task ? 'Edit Task' : 'Add New Task';
            document.getElementById('delete-task-btn').classList.toggle('hidden', !task);

            if(task) {
                document.getElementById('task-id').value = task.id;
                document.getElementById('task-segment').value = getSegmentFromTime(task.time);
                document.getElementById('task-category').value = task.category;
                document.getElementById('task-name').value = task.name;
                document.getElementById('task-priority').value = task.priority;
                document.getElementById('task-time').value = task.time;
                document.getElementById('task-status').value = task.status;
                document.getElementById('task-notes').value = task.notes;
                document.getElementById('task-moved-date').value = '';
                document.getElementById('task-moved-time').value = '';
                document.getElementById('task-moved-container').classList.toggle('hidden', task.status !== 'Moved');
            } else {
                 document.getElementById('task-id').value = '';
                 document.getElementById('task-segment').value = segment;
                 document.getElementById('task-category').value = 'Office / Work';
                 document.getElementById('task-name').value = '';
                 document.getElementById('task-priority').value = 'Medium';
                 document.getElementById('task-time').value = '';
                 document.getElementById('task-status').value = 'Planned';
                 document.getElementById('task-notes').value = '';
                 document.getElementById('task-moved-date').value = '';
                 document.getElementById('task-moved-time').value = '';
                 document.getElementById('task-moved-container').classList.add('hidden');
            }

            modal.classList.remove('hidden');
        };

        document.getElementById('task-status').addEventListener('change', (e) => {
            document.getElementById('task-moved-container').classList.toggle('hidden', e.target.value !== 'Moved');
        });

        document.getElementById('save-task-btn').addEventListener('click', () => {
            const originalDate = workPlanDatePicker.value;
            if(!originalDate) { alert('No date selected.'); return; }

            const taskId = document.getElementById('task-id').value;
            const status = document.getElementById('task-status').value;

            if (status === 'Moved') {
                const movedDate = document.getElementById('task-moved-date').value;
                const movedTime = document.getElementById('task-moved-time').value;

                if (!movedDate || !movedTime) {
                    alert('Please select a new date and time for the moved task.');
                    return;
                }

                // Prepare the task object for its new location
                const taskToMove = {
                    id: taskId ? parseInt(taskId) : Date.now(),
                    category: document.getElementById('task-category').value,
                    name: document.getElementById('task-name').value,
                    priority: document.getElementById('task-priority').value,
                    time: movedTime, // Set the task's time to the new time
                    status: 'Planned', // Reset status for the new date
                    notes: document.getElementById('task-notes').value,
                };
                
                if (!taskToMove.name) {
                    alert('Task Name is required.');
                    return;
                }

                // Remove from original date if it's an existing task
                if (taskId && workPlanData[originalDate]) {
                    workPlanData[originalDate] = workPlanData[originalDate].filter(t => t.id !== parseInt(taskId));
                    if (workPlanData[originalDate].length === 0) {
                        delete workPlanData[originalDate];
                    }
                }

                // Add to the new date
                if (!workPlanData[movedDate]) {
                    workPlanData[movedDate] = [];
                }
                 // Prevent duplicates if moving within the same day
                workPlanData[movedDate] = workPlanData[movedDate].filter(t => t.id !== taskToMove.id);
                workPlanData[movedDate].push(taskToMove);
                
                showToast(`Task moved to ${movedDate}`);

            } else {
                // Logic for non-moved tasks (add/edit in place)
                const taskData = {
                    id: taskId ? parseInt(taskId) : Date.now(),
                    category: document.getElementById('task-category').value,
                    name: document.getElementById('task-name').value,
                    priority: document.getElementById('task-priority').value,
                    time: document.getElementById('task-time').value,
                    status: status,
                    notes: document.getElementById('task-notes').value,
                };

                if (!taskData.name || !taskData.time) { alert('Task Name and Time are required.'); return; }

                if (!workPlanData[originalDate]) workPlanData[originalDate] = [];
                
                if (taskId) { // Editing existing task
                    workPlanData[originalDate] = workPlanData[originalDate].map(t => t.id === taskData.id ? taskData : t);
                } else { // Adding new task
                    workPlanData[originalDate].push(taskData);
                }
            }

            saveData('workPlanData', workPlanData);
            renderWorkPlan(originalDate);
            renderDashboardStatusList(selectedDateForSchedule);
            renderAppDashboard();
            renderCalendar(); // Re-render calendar to show data indicators on new/old dates
            document.getElementById('task-modal').classList.add('hidden');
        });
        
         document.getElementById('delete-task-btn').addEventListener('click', () => {
             const date = workPlanDatePicker.value;
             const taskId = parseInt(document.getElementById('task-id').value);
             if (date && taskId) {
                 workPlanData[date] = workPlanData[date].filter(t => t.id !== taskId);
                 saveData('workPlanData', workPlanData);
                 renderWorkPlan(date);
                 renderDashboardStatusList(selectedDateForSchedule); // Update main dashboard
                 renderAppDashboard();
                 document.getElementById('task-modal').classList.add('hidden');
             }
         });
        
        workPlanDatePicker.addEventListener('change', (e) => {
            renderWorkPlan(e.target.value);
        });

        // --- Status List Logic (now driven by Work Plan)---
        const statusListEl = document.getElementById('status-list');
        const renderDashboardStatusList = (date) => {
            const targetDate = date || localDateToYYYYMMDD(todayDate);
            const headerDateEl = document.getElementById('work-schedule-header-date');
            if (targetDate === localDateToYYYYMMDD(todayDate)) {
                headerDateEl.textContent = ' for Today';
            } else {
                headerDateEl.textContent = ` for ${targetDate}`;
            }
            
            statusListEl.innerHTML = '';
            
            const allTasks = workPlanData[targetDate] || [];

            if (allTasks.length === 0) {
                 statusListEl.innerHTML = '<p class="text-gray-500 text-center py-4">No tasks scheduled for this day.</p>';
                 return;
            }

            const statusMap = { 'Done': 'border-green-500', 'In Progress': 'border-yellow-500', 'Planned': 'border-blue-500', 'Skipped': 'border-gray-500', 'Moved': 'border-purple-500' };
            const colorMap = { 'Done': 'bg-green-100 text-green-800', 'In Progress': 'bg-yellow-100 text-yellow-800', 'Planned': 'bg-blue-100 text-blue-800', 'Skipped': 'bg-gray-100 text-gray-800', 'Moved': 'bg-purple-100 text-purple-800' };

            allTasks.sort((a,b) => (a.time || '00:00').localeCompare(b.time || '00:00')).forEach(task => {
                const div = document.createElement('div');
                div.className = `bg-white p-3 rounded-lg shadow-sm border-l-4 ${statusMap[task.status] || 'border-gray-300'} space-y-1`;
                div.dataset.taskId = task.id;
                
                div.innerHTML = `
                    <div class="flex justify-between items-center">
                        <p class="font-bold text-sm text-gray-800">${task.name}</p>
                        <button class="status-change-btn text-xs font-semibold px-2 py-0.5 rounded-full transition-transform hover:scale-110 ${colorMap[task.status] || 'bg-gray-100 text-gray-800'}">${task.status}</button>
                    </div>
                    <div class="flex justify-between text-xs text-gray-500">
                        <span><i data-lucide="tag" class="inline-block w-3 h-3 mr-1"></i>${(task.category || 'Office / Work').split(' ')[0]}</span>
                        <span><i data-lucide="clock" class="inline-block w-3 h-3 mr-1"></i>${task.time}</span>
                    </div>`;
                statusListEl.appendChild(div);
            });
            
            statusListEl.querySelectorAll('.status-change-btn').forEach(btn => {
                btn.addEventListener('click', (e) => {
                    e.stopPropagation();
                    const taskId = parseInt(e.target.closest('[data-task-id]').dataset.taskId);
                    const tasksForSelectedDate = workPlanData[selectedDateForSchedule];
                    if (!tasksForSelectedDate) return;

                    const task = tasksForSelectedDate.find(t => t.id === taskId);
                    if (!task) return;
                    
                    const statuses = ['Planned', 'In Progress', 'Done', 'Skipped'];
                    const currentIndex = statuses.indexOf(task.status);
                    const nextIndex = (currentIndex + 1) % statuses.length;
                    task.status = statuses[nextIndex];

                    saveData('workPlanData', workPlanData);
                    renderDashboardStatusList(selectedDateForSchedule);
                    renderAppDashboard();
                    
                    const workPlanModal = document.getElementById('work-plan-modal');
                    if (!workPlanModal.classList.contains('hidden') && document.getElementById('work-plan-date-picker').value === selectedDateForSchedule) {
                        renderWorkPlan(selectedDateForSchedule);
                    }
                });
            });

            lucide.createIcons();
        };
        
        // --- App Dashboard Logic ---
        const renderAppDashboard = () => {
            const today = localDateToYYYYMMDD(todayDate);
            const allTasks = workPlanData[today] || [];
            const totalTasks = allTasks.length;

            // Productivity Score
            const doneTasks = allTasks.filter(t => t.status === 'Done').length;
            const productivityPercentage = totalTasks > 0 ? Math.round((doneTasks / totalTasks) * 100) : 0;
            document.getElementById('productivity-score').textContent = `${productivityPercentage}%`;
            document.getElementById('productivity-tasks').textContent = `${doneTasks}/${totalTasks} Tasks Done`;
            
            // Daily Score
            const finalScore = calculateDailyScore(today);
            document.getElementById('daily-score-dashboard').textContent = `${finalScore} / 120`;

            // Category Breakdown
            const personalTasks = allTasks.filter(t => (t.category || '').includes('Personal')).length;
            const officeTasks = allTasks.filter(t => (t.category || '').includes('Office')).length;
            document.getElementById('category-personal-count').textContent = `${personalTasks}/${totalTasks}`;
            document.getElementById('category-office-count').textContent = `${officeTasks}/${totalTasks}`;
            document.getElementById('category-personal-bar').style.width = `${totalTasks > 0 ? (personalTasks / totalTasks) * 100 : 0}%`;
            document.getElementById('category-office-bar').style.width = `${totalTasks > 0 ? (officeTasks / totalTasks) * 100 : 0}%`;

            // Priority Distribution
            const highPriority = allTasks.filter(t => t.priority === 'High').length;
            const mediumPriority = allTasks.filter(t => t.priority === 'Medium').length;
            document.getElementById('priority-high-count').textContent = `${highPriority}/${totalTasks}`;
            document.getElementById('priority-medium-count').textContent = `${mediumPriority}/${totalTasks}`;
            document.getElementById('priority-high-bar').style.width = `${totalTasks > 0 ? (highPriority / totalTasks) * 100 : 0}%`;
            document.getElementById('priority-medium-bar').style.width = `${totalTasks > 0 ? (mediumPriority / totalTasks) * 100 : 0}%`;
        };
        
        // --- NEW: Task Health Dashboard Rendering ---
        const renderTaskHealthDashboard = () => {
            const today = localDateToYYYYMMDD(todayDate);
            const todayRecords = Object.values(hourlyRecords[today] || {});
            
            // Aggregate data
            let totalWater = 0, totalWorkout = 0, totalWork = 0, totalScreen = 0;
            let foodIcons = '';
            const wellbeingLabels = [], moodData = [], stressData = [], selfControlData = [];

            const sortedSlots = Object.keys(hourlyRecords[today] || {}).sort((a,b) => a - b);
            
            sortedSlots.forEach(slot => {
                const rec = hourlyRecords[today][slot];
                totalWater += parseFloat(rec.water) || 0;
                totalWorkout += parseFloat(rec.workout) || 0;
                totalWork += parseFloat(rec.work) || 0;
                totalScreen += parseFloat(rec.screen) || 0;

                if (rec.food && rec.food !== 'N/A') {
                    const icon = {'Healthy': 'leaf', 'Normal': 'utensils', 'Junk': 'pizza'}[rec.food];
                    const color = {'Healthy': 'text-green-500', 'Normal': 'text-yellow-500', 'Junk': 'text-red-500'}[rec.food];
                    foodIcons += `<i data-lucide="${icon}" class="w-5 h-5 ${color}"></i>`;
                }
                
                wellbeingLabels.push(`${slot}:00`);
                moodData.push(parseInt(rec.mood) || 0);
                stressData.push(parseInt(rec.stress) || 0);
                selfControlData.push(parseInt(rec.selfControl) || 0);
            });
            
            // Update DOM
            document.getElementById('health-water-intake').textContent = `${totalWater.toFixed(1)} L`;
            document.getElementById('health-workout-time').textContent = `${totalWorkout.toFixed(1)} h`;
            document.getElementById('health-food-quality').innerHTML = foodIcons || '<p class="text-xs text-gray-500">No food recorded</p>';

            const lastTaskCompletion = todayRecords.length ? todayRecords[todayRecords.length - 1].tasks : 0;
            document.getElementById('health-task-completion').textContent = `${lastTaskCompletion}%`;
            
            // Balance Chart (Work vs Screen)
            if (chartInstances.balance) chartInstances.balance.destroy();
            chartInstances.balance = new Chart(document.getElementById('balance-chart').getContext('2d'), {
                type: 'bar',
                data: {
                    labels: ['Balance'],
                    datasets: [
                        { label: 'Work Hours', data: [totalWork], backgroundColor: 'rgba(59, 130, 246, 0.7)'},
                        { label: 'Screen Time', data: [totalScreen], backgroundColor: 'rgba(239, 68, 68, 0.7)'}
                    ]
                },
                options: { scales: { y: { beginAtZero: true, stacked: true }, x: { stacked: true } }, indexAxis: 'y' }
            });

            // Wellbeing Chart (Trends)
            if (chartInstances.wellbeing) chartInstances.wellbeing.destroy();
            chartInstances.wellbeing = new Chart(document.getElementById('wellbeing-chart').getContext('2d'), {
                type: 'line',
                data: {
                    labels: wellbeingLabels,
                    datasets: [
                        { label: 'Mood', data: moodData, borderColor: 'rgb(34, 197, 94)', tension: 0.2 },
                        { label: 'Stress', data: stressData, borderColor: 'rgb(239, 68, 68)', tension: 0.2 },
                        { label: 'Self-Control', data: selfControlData, borderColor: 'rgb(99, 102, 241)', tension: 0.2 },
                    ]
                },
                 options: { scales: { y: { beginAtZero: true, max: 10 } } }
            });

            lucide.createIcons();
        };

        // --- Calendar Action Modal Logic ---
        document.querySelectorAll('.calendar-action-segment-btn').forEach(btn => {
            btn.addEventListener('click', () => {
                const segment = btn.dataset.segment;
                const date = document.getElementById('calendar-action-date').textContent;
                
                if (!date) return;

                if (segment === 'Finance') {
                    generateFinancialReport(date, date);
                } else if (segment === 'Marking') {
                    generateMarkingReport(date, date);
                } else if (segment === 'Work Plan') {
                    generateComprehensiveWorkPlanReport(date, date);
                }

                document.getElementById('calendar-date-action-modal').classList.add('hidden');
            });
        });

        // --- Calendar, Logo, User Info, XLSX Logic ---
        let calendarDate = new Date(); // Use live date
        let todayDate = new Date(); // Use live date, make it 'let' to be updatable

        // Function to check for date change and update UI
        const checkForDateChange = () => {
            const now = new Date();
            // This log will appear in your browser's developer console every minute
            console.log(`Checking for date change at ${now.toLocaleTimeString()}. Current app date: ${todayDate.toLocaleDateString()}`);

            // Compare day, month, and year. 
            if (now.getDate() !== todayDate.getDate() || now.getMonth() !== todayDate.getMonth() || now.getFullYear() !== todayDate.getFullYear()) {
                console.log("New day detected, refreshing UI for the new date!");
                todayDate = now; // Update the global date
                calendarDate = new Date(); // Reset calendar view
                
                // Re-initialize parts of the app for the new day
                selectedDateForSchedule = todayDate.toISOString().split('T')[0];
                renderCalendar();
                renderDashboardStatusList(selectedDateForSchedule);
                renderAppDashboard();
                renderTaskHealthDashboard();
                showGoodMorningPopup();
                document.getElementById('transaction-date').value = selectedDateForSchedule;
                document.getElementById('forecast-date-picker').value = selectedDateForSchedule;
            }
        };


        const renderCalendar = () => {
            const calendarEl = document.getElementById('calendar');
            const year = calendarDate.getFullYear(), month = calendarDate.getMonth();
            const monthNames = ["January", "February", "March", "April", "May", "June", "July", "August", "September", "October", "November", "December"];
            const daysOfWeek = ['Sun', 'Mon', 'Tue', 'Wed', 'Thu', 'Fri', 'Sat'];
            const firstDayOfMonth = new Date(year, month, 1).getDay();
            const daysInMonth = new Date(year, month + 1, 0).getDate();
            
            let html = `
                <div class="flex items-center justify-between mb-4">
                    <button id="prev-month-cal" class="p-2 rounded-full hover:bg-gray-100"><i data-lucide="chevron-left" class="w-5 h-5"></i></button>
                    <h3 class="text-lg font-semibold">${monthNames[month]} ${year}</h3>
                    <button id="next-month-cal" class="p-2 rounded-full hover:bg-gray-100"><i data-lucide="chevron-right" class="w-5 h-5"></i></button>
                </div>
                <div class="grid grid-cols-7 gap-1 text-center text-xs text-gray-500 font-semibold">${daysOfWeek.map(day => `<div>${day}</div>`).join('')}</div>
                <div class="grid grid-cols-7 gap-2 mt-2 text-center">`;

            for (let i = 0; i < firstDayOfMonth; i++) html += `<div></div>`;

            const todayStr = localDateToYYYYMMDD(new Date());

            for (let day = 1; day <= daysInMonth; day++) {
                const dateStr = `${year}-${String(month + 1).padStart(2, '0')}-${String(day).padStart(2, '0')}`;
                const isToday = dateStr === todayStr;
                const isSelected = dateStr === selectedDateForSchedule;
                
                let classes = 'calendar-day w-9 h-9 flex items-center justify-center rounded-full cursor-pointer';
                const hasData = financeTransactions.some(t => t.date === dateStr) || markingHistory[dateStr] || (workPlanData[dateStr] && workPlanData[dateStr].length > 0) || hourlyRecords[dateStr];
                
                if (isSelected) {
                    classes += ' bg-red-600 text-white font-bold ring-2 ring-red-300';
                } else if (isToday) {
                    classes += ' bg-red-200 text-red-800 font-bold';
                }
                 else if (hasData) {
                    classes += ' bg-red-100 text-red-700 font-semibold';
                } else {
                    classes += ' text-gray-700 hover:bg-gray-100';
                }
                
                html += `<div class="${classes}" data-date="${dateStr}">${day}</div>`;
            }
            calendarEl.innerHTML = html + `</div>`;

            document.getElementById('prev-month-cal').addEventListener('click', () => {
                calendarDate.setMonth(calendarDate.getMonth() - 1);
                renderCalendar();
            });

            document.getElementById('next-month-cal').addEventListener('click', () => {
                calendarDate.setMonth(calendarDate.getMonth() + 1);
                renderCalendar();
            });

            document.querySelectorAll('.calendar-day').forEach(dayEl => {
                dayEl.addEventListener('click', () => {
                    const date = dayEl.dataset.date;
                    if (date) {
                         selectedDateForSchedule = date;
                         renderCalendar(); // Re-render to update selection style
                         renderDashboardStatusList(date); // This updates the work schedule box

                         // Open the new modal
                         document.getElementById('calendar-action-date').textContent = date;
                         document.getElementById('calendar-date-action-modal').classList.remove('hidden');
                    }
                });
            });
            lucide.createIcons();
        };

        document.getElementById('upload-logo-button').addEventListener('click', () => document.getElementById('logo-uploader').click());
        document.getElementById('logo-uploader').addEventListener('change', (e) => {
            if (e.target.files[0]) {
                const reader = new FileReader();
                reader.onload = (re) => {
                    const logoData = re.target.result;
                    document.getElementById('logo-image').src = logoData;
                    saveData('logo', logoData);
                    document.getElementById('logo-image').classList.remove('hidden');
                    document.getElementById('upload-logo-button').style.display = 'none';
                };
                reader.readAsDataURL(e.target.files[0]);
            }
        });

        document.getElementById('save-user-info').addEventListener('click', () => {
            const name = document.getElementById('user-name').value.trim();
            const mobile = document.getElementById('user-mobile').value.trim();
            if (name && mobile) {
                saveData('userInfo', { name, mobile });
                document.getElementById('user-info-modal').classList.add('hidden');
            } else alert('Please fill both name and mobile number.');
        });

        document.getElementById('download-xlsx').addEventListener('click', () => {
            const wb = XLSX.utils.book_new();
            const markingsArray = Object.keys(markingHistory).map(date => ({ date, ...markingHistory[date] }));
            const hourlyArray = Object.entries(hourlyRecords).flatMap(([date, slots]) => Object.entries(slots).map(([slot, data]) => ({date, slot, ...data})));
            const workPlanArray = Object.entries(workPlanData).flatMap(([date, tasks]) => tasks.map(task => ({ date, ...task })));

            XLSX.utils.book_append_sheet(wb, XLSX.utils.json_to_sheet([loadData('userInfo', {})]), "Personal Info");
            XLSX.utils.book_append_sheet(wb, XLSX.utils.json_to_sheet(workPlanArray), "Work Plan");
            XLSX.utils.book_append_sheet(wb, XLSX.utils.json_to_sheet(financeTransactions), "Transactions");
            XLSX.utils.book_append_sheet(wb, XLSX.utils.json_to_sheet(financeBorrowers), "Borrowers");
            XLSX.utils.book_append_sheet(wb, XLSX.utils.json_to_sheet(financeForecasts), "Finance Forecasts");
            XLSX.utils.book_append_sheet(wb, XLSX.utils.json_to_sheet(markingsArray), "End of Day Summary");
            XLSX.utils.book_append_sheet(wb, XLSX.utils.json_to_sheet(hourlyArray), "Hourly Records");

            XLSX.writeFile(wb, "personal bank statement.xlsx");
        });

        document.getElementById('upload-xlsx').addEventListener('click', () => document.getElementById('xlsx-uploader').click());
        document.getElementById('xlsx-uploader').addEventListener('change', (e) => {
            if (e.target.files[0]) {
                const reader = new FileReader();
                reader.onload = (re) => {
                    try {
                        const workbook = XLSX.read(new Uint8Array(re.target.result), { type: 'array' });
                        const loadSheet = (sheetName, key, dataSetter, renderer) => {
                            const ws = workbook.Sheets[sheetName];
                            if (ws) {
                                let data = XLSX.utils.sheet_to_json(ws);
                                saveData(key, data);
                                dataSetter(data);
                                if (renderer) renderer();
                            }
                        };
                        
                        loadSheet("Personal Info", 'userInfo', data => saveData('userInfo', data[0] || {}));
                        loadSheet("Transactions", 'financeTransactions', data => financeTransactions = data, () => renderTransactionsForDate(transactionDateInput.value));
                        loadSheet("Borrowers", 'financeBorrowers', data => financeBorrowers = data, renderBorrowers);
                        loadSheet("Finance Forecasts", 'financeForecasts', data => financeForecasts = data, renderForecasts);
                        
                        const markingsSheet = workbook.Sheets["End of Day Summary"];
                        if (markingsSheet) {
                            const markingsArray = XLSX.utils.sheet_to_json(markingsSheet);
                            const newMarkingHistory = {};
                            markingsArray.forEach(row => {
                                const date = row.date;
                                if (date) { delete row.date; newMarkingHistory[date] = row; }
                            });
                            markingHistory = newMarkingHistory;
                            saveData('markingHistory', markingHistory);
                        }
                        
                        const hourlySheet = workbook.Sheets["Hourly Records"];
                        if(hourlySheet) {
                            const hourlyArray = XLSX.utils.sheet_to_json(hourlySheet);
                            const newHourlyRecords = {};
                            hourlyArray.forEach(row => {
                                const {date, slot, ...data} = row;
                                if (date && slot !== undefined) {
                                    if(!newHourlyRecords[date]) newHourlyRecords[date] = {};
                                    newHourlyRecords[date][slot] = data;
                                }
                            });
                            hourlyRecords = newHourlyRecords;
                            saveData('hourlyRecords', hourlyRecords);
                        }

                        const workPlanSheet = workbook.Sheets["Work Plan"];
                         if (workPlanSheet) {
                            const workPlanArray = XLSX.utils.sheet_to_json(workPlanSheet);
                            const newWorkPlanData = {};
                            workPlanArray.forEach(row => {
                                const date = row.date;
                                if (date) {
                                    if (!newWorkPlanData[date]) newWorkPlanData[date] = [];
                                    delete row.date;
                                    newWorkPlanData[date].push(row);
                                }
                            });
                            workPlanData = newWorkPlanData;
                            saveData('workPlanData', workPlanData);
                        }

                        alert('Data successfully uploaded and applied!');
                        initApp(); // Re-initialize to reflect all changes
                    } catch (error) {
                        alert('Error reading the XLSX file. Please ensure it is a valid file.');
                        console.error("XLSX Read Error:", error);
                    }
                };
                reader.readAsArrayBuffer(e.target.files[0]);
            }
        });
        
        // --- On-Demand Reporting ---
        document.querySelectorAll('#report-segment-choice-modal .report-segment-btn').forEach(btn => {
            btn.addEventListener('click', () => {
                const segment = btn.dataset.segment;
                document.getElementById('date-range-report-title').textContent = `${segment} Report`;
                document.getElementById('report-segment-choice-modal').classList.add('hidden');
                document.getElementById('date-range-report-modal').classList.remove('hidden');
                document.getElementById('range-report-content').innerHTML = ''; 
            });
        });

        document.getElementById('generate-range-report-btn').addEventListener('click', () => {
            const startDate = document.getElementById('report-start-date').value;
            const endDate = document.getElementById('report-end-date').value;
            if (!startDate || !endDate || startDate > endDate) {
                alert('Please select a valid start and end date.');
                return;
            }
            const segment = document.getElementById('date-range-report-title').textContent.replace(' Report', '');

            if (segment === 'Finance') {
                generateFinancialReport(startDate, endDate);
            } else if (segment === 'Marking') {
                generateMarkingReport(startDate, endDate);
            } else if (segment === 'Work Plan') {
                 generateComprehensiveWorkPlanReport(startDate, endDate);
            }
            document.getElementById('date-range-report-modal').classList.add('hidden');
        });

        const generateFinancialReport = (startDate, endDate) => {
            const modalContainer = document.getElementById('comprehensive-report-modal');
            modalContainer.innerHTML = `
                <div class="bg-white rounded-xl shadow-2xl w-full max-w-4xl h-[95vh] flex flex-col">
                     <div class="p-4 border-b flex flex-wrap justify-between items-center gap-4 sticky top-0 bg-white z-20 rounded-t-xl">
                        <h2 class="text-xl font-bold text-gray-800">Financial Report</h2>
                        <div class="flex items-center gap-2 flex-wrap">
                            <button id="save-report-jpeg-new" class="bg-blue-500 text-white font-semibold py-2 px-4 rounded-lg text-sm flex items-center gap-2 hover:bg-blue-600"><i data-lucide="image" class="w-4 h-4"></i>Save as JPEG</button>
                            <button id="save-report-pdf-new" class="bg-red-500 text-white font-semibold py-2 px-4 rounded-lg text-sm flex items-center gap-2 hover:bg-red-600"><i data-lucide="file-text" class="w-4 h-4"></i>Save as PDF</button>
                            <button id="close-comprehensive-report-modal-new" class="bg-gray-500 text-white font-semibold p-2 rounded-full hover:bg-gray-600"><i data-lucide="x" class="w-5 h-5"></i></button>
                        </div>
                    </div>
                    <div id="report-scroll-container" class="flex-grow overflow-y-auto overflow-x-hidden p-4 sm:p-6 bg-gray-200">
                        <div id="a4-page-wrapper" class="a4-page-preview shadow-lg report-watermark-bg mx-auto">
                            <div id="comprehensive-report-content" class="space-y-6 relative z-10 bg-transparent"></div>
                        </div>
                    </div>
                </div>`;
            
            document.getElementById('close-comprehensive-report-modal-new').addEventListener('click', () => modalContainer.classList.add('hidden'));
            document.getElementById('save-report-jpeg-new').addEventListener('click', () => saveReport('jpeg'));
            document.getElementById('save-report-pdf-new').addEventListener('click', () => saveReport('pdf'));
            
            modalContainer.addEventListener('click', (e) => {
                if (e.target.classList.contains('view-report-note-btn') || e.target.closest('.view-report-note-btn')) {
                    const button = e.target.closest('.view-report-note-btn');
                    const note = button.dataset.transactionNote;
                    if (note) {
                        document.getElementById('note-display-content').textContent = note;
                        document.getElementById('note-display-modal').classList.remove('hidden');
                    }
                }
            });

            lucide.createIcons();

            const contentEl = document.getElementById('comprehensive-report-content');
            const userInfo = loadData('userInfo', {name: 'N/A', mobile: 'N/A'});
            
            // --- Data Processing for Report ---
            const rangeTransactions = financeTransactions.filter(t => t.date >= startDate && t.date <= endDate);
            const rangeBorrowers = financeBorrowers.filter(b => (b.date >= startDate && b.date <= endDate) || (b.commitDate >= startDate && b.commitDate <= endDate));
            
            let dailyTotals = {};
            rangeTransactions.forEach(t => {
                if(!dailyTotals[t.date]) dailyTotals[t.date] = { income: 0, expense: 0 };
                if (t.type === 'income') dailyTotals[t.date].income += parseFloat(t.amount || 0);
                else dailyTotals[t.date].expense += parseFloat(t.amount || 0);
            });

            const numDays = Math.max(1, Object.keys(dailyTotals).length);
            const totalActualIncome = Object.values(dailyTotals).reduce((sum, day) => sum + day.income, 0);
            const totalActualExpense = Object.values(dailyTotals).reduce((sum, day) => sum + day.expense, 0);
            const overallBalance = totalActualIncome - totalActualExpense;

            // --- Source Balance Calculation ---
            const allTransactionsUpToEndDate = financeTransactions.filter(t => t.date <= endDate);
            const sources = ['BKash', 'Rocket', 'Nagad', 'Bank Acc.', 'Cash'];
            const sourceBalances = sources.reduce((acc, source) => ({ ...acc, [source]: 0 }), {});

            allTransactionsUpToEndDate.forEach(t => {
                if (sources.includes(t.source)) {
                    const amount = parseFloat(t.amount || 0);
                    if (t.type === 'income') {
                        sourceBalances[t.source] += amount;
                    } else {
                        sourceBalances[t.source] -= amount;
                    }
                }
            });


            let totalForecastIncome = 0;
            let totalForecastExpense = 0;
            const uniqueWeeks = [...new Set(rangeTransactions.map(t => getWeekRange(t.date).start))];
            uniqueWeeks.forEach(weekStart => {
                const forecast = financeForecasts.find(f => f.weekStart === weekStart);
                if(forecast){
                    totalForecastIncome += parseFloat(forecast.cashIn || 0);
                    totalForecastExpense += parseFloat(forecast.expense || 0);
                }
            });

            const forecastAccuracy = totalForecastIncome > 0 ? (totalActualIncome / totalForecastIncome) * 100 : 100;
            const avgDailyIncome = totalActualIncome / numDays;
            const avgDailyExpense = totalActualExpense / numDays;

            let highestIncomeDay = { date: 'N/A', amount: -1 };
            let highestExpenseDay = { date: 'N/A', amount: -1 };
            Object.entries(dailyTotals).forEach(([date, values]) => {
                if (values.income > highestIncomeDay.amount) highestIncomeDay = { date, amount: values.income };
                if (values.expense > highestExpenseDay.amount) highestExpenseDay = { date, amount: values.expense };
            });

            const incomeTransactions = rangeTransactions.filter(t => t.type === 'income');
            const expenseTransactions = rangeTransactions.filter(t => t.type === 'expense');

            const maxIncomeTx = incomeTransactions.length > 0 ? incomeTransactions.reduce((max, t) => parseFloat(t.amount) > parseFloat(max.amount) ? t : max) : null;
            const minIncomeTx = incomeTransactions.length > 0 ? incomeTransactions.reduce((min, t) => parseFloat(t.amount) < parseFloat(min.amount) ? t : min) : null;
            const maxExpenseTx = expenseTransactions.length > 0 ? expenseTransactions.reduce((max, t) => parseFloat(t.amount) > parseFloat(max.amount) ? t : max) : null;
            const minExpenseTx = expenseTransactions.length > 0 ? expenseTransactions.reduce((min, t) => parseFloat(t.amount) < parseFloat(min.amount) ? t : min) : null;

            // --- Conditional Table Generation ---
            let transactionsTableHtml = '';
            const isSingleDayReport = startDate === endDate;

            if (isSingleDayReport) {
                // Detailed breakdown for a single day
                transactionsTableHtml = `
                    <div class="overflow-x-auto custom-scrollbar">
                        <table class="w-full text-xs">
                            <thead class="bg-gray-200 sticky top-0"><tr class="text-left text-gray-600">
                                <th class="p-2 font-semibold">Purpose</th>
                                <th class="p-2 font-semibold">Source</th>
                                <th class="p-2 font-semibold text-right">Cash In (BDT)</th>
                                <th class="p-2 font-semibold text-right">Expense (BDT)</th>
                            </tr></thead>
                            <tbody>${rangeTransactions.map(t => {
                                const income = t.type === 'income' ? parseFloat(t.amount).toFixed(2) : '-';
                                const expense = t.type === 'expense' ? parseFloat(t.amount).toFixed(2) : '-';
                                const noteIcon = t.note ? `<i data-lucide="sticky-note" class="inline-block w-3 h-3 ml-1 text-blue-500 cursor-pointer view-report-note-btn" data-transaction-note="${t.note.replace(/"/g, '&quot;')}"></i>` : '';
                                return `<tr class="border-t">
                                    <td class="p-2">${t.purpose}</td>
                                    <td class="p-2">${t.source}</td>
                                    <td class="p-2 text-right text-green-600">${income}${noteIcon}</td>
                                    <td class="p-2 text-right text-red-600">${expense}${noteIcon}</td>
                                </tr>`;
                            }).join('') || `<tr><td colspan="4" class="text-center p-4 text-gray-500">No transactions for this day.</td></tr>`}</tbody>
                        </table>
                    </div>`;
            } else {
                // Aggregated summary for a date range
                 transactionsTableHtml = `
                    <div class="overflow-x-auto custom-scrollbar">
                        <table class="w-full text-xs">
                            <thead class="bg-gray-200 sticky top-0"><tr class="text-left text-gray-600">
                                <th class="p-2 font-semibold">Date</th>
                                <th class="p-2 font-semibold text-right">Total Cash In (BDT)</th>
                                <th class="p-2 font-semibold text-right">Total Expense (BDT)</th>
                                <th class="p-2 font-semibold text-right">Balance (BDT)</th>
                            </tr></thead>
                            <tbody>${Object.entries(dailyTotals).map(([date, totals]) => {
                                const balance = totals.income - totals.expense;
                                return `<tr class="border-t">
                                    <td class="p-2">${date}</td>
                                    <td class="p-2 text-right text-green-600">${totals.income.toFixed(2)}</td>
                                    <td class="p-2 text-right text-red-600">${totals.expense.toFixed(2)}</td>
                                    <td class="p-2 text-right font-bold ${balance >= 0 ? 'text-green-700' : 'text-red-700'}">${balance.toFixed(2)}</td>
                                </tr>`;
                            }).join('') || `<tr><td colspan="4" class="text-center p-4 text-gray-500">No transactions in this date range.</td></tr>`}</tbody>
                        </table>
                    </div>`;
            }

            // --- Source Balance HTML ---
            const sourceBalancesHtml = `
                <div>
                    <h4 class="font-bold text-gray-700 mb-2">Source Balances (as of ${endDate})</h4>
                    <div class="grid grid-cols-2 sm:grid-cols-3 lg:grid-cols-5 gap-2 text-xs">
                        ${Object.entries(sourceBalances).map(([source, balance]) => `
                            <div class="bg-gray-50 p-2 rounded-lg border text-center">
                                <p class="font-semibold text-gray-600">${source}</p>
                                <p class="font-bold text-base ${balance >= 0 ? 'text-gray-800' : 'text-red-600'}">${balance.toFixed(2)}</p>
                            </div>
                        `).join('')}
                    </div>
                </div>`;
            
            // --- Borrower Table HTML ---
            const borrowersTableHtml = rangeBorrowers.length > 0 ? `
                <div>
                    <h4 class="font-bold text-gray-700 mb-2">Borrower Details</h4>
                    <div class="max-h-60 overflow-y-auto overflow-x-auto custom-scrollbar border rounded-lg bg-white">
                        <table class="w-full text-xs">
                            <thead class="bg-gray-200 sticky top-0"><tr class="text-left text-gray-600">
                                <th class="p-2 font-semibold">Date</th>
                                <th class="p-2 font-semibold">Borrower</th>
                                <th class="p-2 font-semibold">Lender</th>
                                <th class="p-2 font-semibold text-right">Amount (BDT)</th>
                                <th class="p-2 font-semibold">Commit Date</th>
                                <th class="p-2 font-semibold">Status</th>
                            </tr></thead>
                            <tbody>${rangeBorrowers.map(b => `
                                <tr class="border-t">
                                    <td class="p-2">${b.date}</td>
                                    <td class="p-2">${b.name}</td>
                                    <td class="p-2">${b.lender || 'N/A'}</td>
                                    <td class="p-2 text-right">${parseFloat(b.amount).toFixed(2)}</td>
                                    <td class="p-2">${b.commitDate}</td>
                                    <td class="p-2">${b.status}</td>
                                </tr>`).join('')}
                            </tbody>
                        </table>
                    </div>
                </div>` : '';

            // --- Main HTML Generation ---
            contentEl.innerHTML = `
                 <header class="pb-4 mb-6">
                    <div class="flex flex-col sm:flex-row justify-between items-start gap-4">
                        <div>
                            <h2 class="text-2xl font-bold text-blue-800">FINANCIAL STATEMENT</h2>
                            <p class="text-gray-500 font-semibold" style="font-family: 'Orbitron', sans-serif;">TRACK ME</p>
                        </div>
                        <div class="text-left sm:text-right">
                             <p class="font-semibold text-gray-700">Date Range</p>
                             <p class="text-sm text-gray-500">${startDate} to ${endDate}</p>
                        </div>
                    </div>
                    <div class="mt-6 border border-gray-300 rounded-lg p-3 grid grid-cols-1 sm:grid-cols-3 gap-4 text-sm">
                        <div><p class="font-semibold text-gray-500">Name</p><p>${userInfo.name || 'N/A'}</p></div>
                        <div><p class="font-semibold text-gray-500">Mobile</p><p>${userInfo.mobile || 'N/A'}</p></div>
                        <div><p class="font-semibold text-gray-500">Report</p><p>${new Date().toLocaleDateString()}</p></div>
                    </div>
                </header>

                <main class="space-y-6">
                    <div class="bg-gray-100/60 p-4 rounded-lg grid grid-cols-2 lg:grid-cols-4 gap-x-4 gap-y-6 text-center">
                        <div><p class="text-gray-500 text-sm">Total Cash In</p><p class="font-bold text-lg">${totalActualIncome.toFixed(2)}</p><p class="text-xs text-gray-400">Forecast: ${totalForecastIncome.toFixed(2)}</p></div>
                        <div><p class="text-gray-500 text-sm">Total Expenses</p><p class="font-bold text-lg">${totalActualExpense.toFixed(2)}</p><p class="text-xs text-gray-400">Forecast: ${totalForecastExpense.toFixed(2)}</p></div>
                        <div><p class="text-gray-500 text-sm">Avg Daily Income</p><p class="font-bold text-lg">${avgDailyIncome.toFixed(2)}</p></div>
                        <div><p class="text-gray-500 text-sm">Avg Daily Expense</p><p class="font-bold text-lg">${avgDailyExpense.toFixed(2)}</p></div>
                        <div><p class="text-gray-500 text-sm">Overall Balance</p><p class="font-bold text-lg ${overallBalance >= 0 ? 'text-green-600' : 'text-red-600'}">${overallBalance.toFixed(2)}</p></div>
                        <div><p class="text-gray-500 text-sm">Forecast Accuracy</p><p class="font-bold text-lg">${forecastAccuracy.toFixed(1)}%</p></div>
                        <div><p class="text-gray-500 text-sm">Highest Income Day</p><p class="font-bold text-lg">${highestIncomeDay.date}</p></div>
                        <div><p class="text-gray-500 text-sm">Highest Expense Day</p><p class="font-bold text-lg">${highestExpenseDay.date}</p></div>
                    </div>

                    ${sourceBalancesHtml}

                    <div>
                        <h4 class="font-bold text-gray-700 mb-2">Cash In & Expenses</h4>
                        <div class="max-h-60 overflow-y-auto custom-scrollbar border rounded-lg bg-white">
                            ${transactionsTableHtml}
                        </div>
                    </div>
                    
                    ${borrowersTableHtml}

                    <div>
                        <h4 class="font-bold text-gray-700 mb-2">Maximum & Minimum Transaction Analysis</h4>
                        <div class="border rounded-lg bg-white overflow-hidden overflow-x-auto custom-scrollbar">
                           <table class="w-full text-xs">
                                <thead class="bg-gray-200"><tr class="text-left text-gray-600"><th class="p-2 font-semibold">Date</th><th class="p-2 font-semibold">Source</th><th class="p-2 font-semibold">Purpose</th><th class="p-2 font-semibold text-right">Maximum (BDT)</th><th class="p-2 font-semibold text-right">Minimum (BDT)</th></tr></thead>
                                <tbody>
                                    ${maxIncomeTx ? `<tr class="border-t"><td class="p-2">${maxIncomeTx.date}</td><td class="p-2">${maxIncomeTx.source}</td><td class="p-2">${maxIncomeTx.purpose}</td><td class="p-2 text-right text-green-600 font-bold">${parseFloat(maxIncomeTx.amount).toFixed(2)}</td><td class="p-2 text-right">-</td></tr>` : ''}
                                    ${maxExpenseTx ? `<tr class="border-t"><td class="p-2">${maxExpenseTx.date}</td><td class="p-2">${maxExpenseTx.source}</td><td class="p-2">${maxExpenseTx.purpose}</td><td class="p-2 text-right text-red-600 font-bold">${parseFloat(maxExpenseTx.amount).toFixed(2)}</td><td class="p-2 text-right">-</td></tr>` : ''}
                                    ${minIncomeTx && maxIncomeTx && minIncomeTx.id !== maxIncomeTx.id ? `<tr class="border-t"><td class="p-2">${minIncomeTx.date}</td><td class="p-2">${minIncomeTx.source}</td><td class="p-2">${minIncomeTx.purpose}</td><td class="p-2 text-right">-</td><td class="p-2 text-right text-green-600 font-bold">${parseFloat(minIncomeTx.amount).toFixed(2)}</td></tr>` : ''}
                                    ${minExpenseTx && maxExpenseTx && minExpenseTx.id !== maxExpenseTx.id ? `<tr class="border-t"><td class="p-2">${minExpenseTx.date}</td><td class="p-2">${minExpenseTx.source}</td><td class="p-2">${minExpenseTx.purpose}</td><td class="p-2 text-right">-</td><td class="p-2 text-right text-red-600 font-bold">${parseFloat(minExpenseTx.amount).toFixed(2)}</td></tr>` : ''}
                                </tbody>
                            </table>
                        </div>
                    </div>
                </main>
                <footer class="mt-6 pt-4 border-t-2">
                    <div class="bg-blue-800 text-white p-3 rounded-lg text-xs text-center">For the period ${startDate} to ${endDate}, you had a total income of ${totalActualIncome.toFixed(2)} and expenses of ${totalActualExpense.toFixed(2)}. Your overall balance is ${overallBalance.toFixed(2)}. Your financial performance is ${overallBalance > 0 ? 'strong with a positive cash flow' : 'negative, it is advisable to review your expenses'}.</div>
                    <p class="mt-4 text-center text-xs text-gray-500">ALL COPYRIGHT RESERVED BY MRS @ 2025</p>
                </footer>
            `;
            
            modalContainer.classList.remove('hidden');
             // Must call createIcons after new HTML is injected
            setTimeout(() => lucide.createIcons(), 0);
        };
        
        const getAggregatedMarkingData = (date) => {
            const manualData = markingHistory[date] || {};
            const hourlyData = hourlyRecords[date] || {};

            if (Object.keys(manualData).length === 0 && Object.keys(hourlyData).length === 0) return null;

            const aggregated = {
                sleep: parseFloat(manualData.sleep) || 0,
                prayer: parseInt(manualData.prayer) || 0,
                overall: parseInt(manualData.overall) || 0,
                food: [], water: 0, workout: 0, work: 0, screen: 0,
                selfControl: [], stress: [], mood: [], tasks: []
            };

            Object.values(hourlyData).forEach(rec => {
                if (rec.food && rec.food !== 'N/A') aggregated.food.push(rec.food);
                aggregated.water += parseFloat(rec.water) || 0;
                aggregated.workout += parseFloat(rec.workout) || 0;
                aggregated.work += parseFloat(rec.work) || 0;
                aggregated.screen += parseFloat(rec.screen) || 0;
                aggregated.selfControl.push(parseInt(rec.selfControl) || 0);
                aggregated.stress.push(parseInt(rec.stress) || 0);
                aggregated.mood.push(parseInt(rec.mood) || 0);
                aggregated.tasks.push(parseInt(rec.tasks) || 0);
            });
            
            const avg = arr => arr.length ? arr.reduce((a, b) => a + b, 0) / arr.length : 0;
            const foodScores = aggregated.food.map(f => ({'Healthy': 10, 'Normal': 7, 'Junk': 3}[f] || 0));

            return {
                sleep: aggregated.sleep,
                prayer: aggregated.prayer,
                overall: aggregated.overall,
                food: avg(foodScores),
                water: aggregated.water,
                workout: aggregated.workout,
                work: aggregated.work,
                screen: aggregated.screen,
                selfControl: avg(aggregated.selfControl),
                stress: avg(aggregated.stress),
                mood: avg(aggregated.mood),
                tasks: aggregated.tasks.length ? aggregated.tasks[aggregated.tasks.length - 1] : 0,
            };
        };

        const generateMarkingReport = (startDate, endDate) => {
            const markingElements = [
                { key: 'score', name: 'Overall Score', shortName: 'Score', unit: '/120', max: 120, good: 'high' },
                { key: 'sleep', name: 'Sleep', shortName: 'Sleep', unit: 'hrs', max: 8, good: 'high' },
                { key: 'food', name: 'Food Quality', shortName: 'Food', unit: '/10', max: 10, good: 'high' },
                { key: 'water', name: 'Water', shortName: 'Water', unit: 'L', max: 2.5, good: 'high' },
                { key: 'workout', name: 'Workout', shortName: 'Workout', unit: 'h', max: 0.5, good: 'high' },
                { key: 'prayer', name: 'Prayer', shortName: 'Prayer', unit: '/5', max: 5, good: 'high' },
                { key: 'tasks', name: 'Tasks Done', shortName: 'Tasks', unit: '%', max: 100, good: 'high' },
                { key: 'mood', name: 'Mood Level', shortName: 'Mood', unit: '/10', max: 10, good: 'high' },
                { key: 'selfControl', name: 'Self Control', shortName: 'SelfCtrl', unit: '/10', max: 10, good: 'high' },
                { key: 'overall', name: 'Day Rating', shortName: 'Rating', unit: '/10', max: 10, good: 'high' },
                { key: 'stress', name: 'Stress Level', shortName: 'Stress', unit: '/10', max: 10, good: 'low' },
                { key: 'work', name: 'Work Hours', shortName: 'Work', unit: 'hrs', max: 8, good: 'low' },
                { key: 'screen', name: 'Screen Time', shortName: 'Screen', unit: 'hrs', max: 4, good: 'low' },
            ];

            const getProgressBarColor = (percentage, isGoodHigh) => {
                let score = isGoodHigh ? percentage : 100 - percentage;
                if (score > 75) return 'bg-green-500';
                if (score > 40) return 'bg-yellow-500';
                return 'bg-red-500';
            };

            const modalContainer = document.getElementById('comprehensive-report-modal');
            modalContainer.innerHTML = `
                <div class="bg-white rounded-xl shadow-2xl w-full max-w-4xl h-[95vh] flex flex-col">
                     <div class="p-4 border-b flex flex-wrap justify-between items-center gap-4 sticky top-0 bg-white z-20 rounded-t-xl">
                        <h2 class="text-xl font-bold text-gray-800">Health & Productivity Report</h2>
                        <div class="flex items-center gap-2 flex-wrap">
                            <button id="save-report-jpeg-new" class="bg-blue-500 text-white font-semibold py-2 px-4 rounded-lg text-sm flex items-center gap-2 hover:bg-blue-600"><i data-lucide="image" class="w-4 h-4"></i>Save as JPEG</button>
                            <button id="save-report-pdf-new" class="bg-red-500 text-white font-semibold py-2 px-4 rounded-lg text-sm flex items-center gap-2 hover:bg-red-600"><i data-lucide="file-text" class="w-4 h-4"></i>Save as PDF</button>
                            <button id="close-comprehensive-report-modal-new" class="bg-gray-500 text-white font-semibold p-2 rounded-full hover:bg-gray-600"><i data-lucide="x" class="w-5 h-5"></i></button>
                        </div>
                    </div>
                    <div id="report-scroll-container" class="flex-grow overflow-y-auto overflow-x-hidden p-4 sm:p-6 bg-gray-200">
                        <div id="a4-page-wrapper" class="a4-page-preview shadow-lg report-watermark-bg mx-auto">
                            <div id="comprehensive-report-content" class="space-y-6 relative z-10 bg-transparent"></div>
                        </div>
                    </div>
                </div>`;

            document.getElementById('close-comprehensive-report-modal-new').addEventListener('click', () => modalContainer.classList.add('hidden'));
            document.getElementById('save-report-jpeg-new').addEventListener('click', () => saveReport('jpeg'));
            document.getElementById('save-report-pdf-new').addEventListener('click', () => saveReport('pdf'));
            lucide.createIcons();

            const contentEl = document.getElementById('comprehensive-report-content');
            const userInfo = loadData('userInfo', {name: 'N/A', mobile: 'N/A'});
            const isSingleDay = startDate === endDate;

            let reportHtml = `
                <header class="pb-4 mb-6">
                     <div class="flex flex-col sm:flex-row justify-between items-start gap-4">
                         <div><h2 class="text-2xl font-bold text-blue-800">HEALTH & PRODUCTIVITY REPORT</h2><p class="text-gray-500 font-semibold" style="font-family: 'Orbitron', sans-serif;">TRACK ME</p></div>
                         <div class="text-left sm:text-right"><p class="font-semibold text-gray-700">Date Range</p><p class="text-sm text-gray-500">${startDate}${isSingleDay ? '' : ' to ' + endDate}</p></div>
                     </div>
                     <div class="mt-6 border border-gray-300 rounded-lg p-3 grid grid-cols-1 sm:grid-cols-3 gap-4 text-sm">
                        <div><p class="font-semibold text-gray-500">Name</p><p>${userInfo.name || 'N/A'}</p></div>
                        <div><p class="font-semibold text-gray-500">Mobile</p><p>${userInfo.mobile || 'N/A'}</p></div>
                        <div><p class="font-semibold text-gray-500">Report Date</p><p>${new Date().toLocaleDateString()}</p></div>
                    </div>
                </header>
                <main class="space-y-6">`;

            if (isSingleDay) {
                const dayData = getAggregatedMarkingData(startDate);
                const score = calculateDailyScore(startDate);

                if (!dayData) {
                    contentEl.innerHTML = `<div class="text-center py-10"><h2 class="text-2xl font-bold text-gray-700">No Data Available</h2><p class="text-gray-500 mt-2">There are no marking records for the selected date.</p></div>`;
                    modalContainer.classList.remove('hidden');
                    return;
                }
                dayData.score = score;

                reportHtml += `
                    <div class="bg-gray-100/60 p-4 rounded-lg text-center">
                        <p class="text-gray-600 font-semibold">Total Score</p>
                        <p class="text-3xl font-bold text-blue-800">${score.toFixed(1)} / 120</p>
                    </div>
                    <div>
                        <h4 class="font-bold text-gray-700 mb-2">Performance Breakdown</h4>
                        <div class="space-y-3 text-xs">
                        ${markingElements.map(el => {
                            const value = dayData[el.key] || 0;
                            const percentage = el.max > 0 ? (value / el.max) * 100 : 0;
                            const color = getProgressBarColor(percentage, el.good === 'high');
                            return `
                            <div class="space-y-1">
                                <div class="flex justify-between font-semibold"><p>${el.name}</p><p>${value.toFixed(1)} ${el.unit}</p></div>
                                <div class="w-full bg-gray-200 rounded-full h-2"><div class="${color} h-2 rounded-full" style="width: ${percentage}%"></div></div>
                            </div>`;
                        }).join('')}
                        </div>
                    </div>`;

            } else { // Date Range Report
                const allDaysData = [];
                for (let d = new Date(startDate); d <= new Date(endDate); d.setDate(d.getDate() + 1)) {
                    const dateStr = d.toISOString().slice(0, 10);
                    const dayData = getAggregatedMarkingData(dateStr);
                    if (dayData) {
                        dayData.score = calculateDailyScore(dateStr);
                        dayData.date = dateStr;
                        allDaysData.push(dayData);
                    }
                }
                
                if (allDaysData.length === 0) {
                     contentEl.innerHTML = `<div class="text-center py-10"><h2 class="text-2xl font-bold text-gray-700">No Data Available</h2><p class="text-gray-500 mt-2">There are no marking records for the selected date range.</p></div>`;
                     modalContainer.classList.remove('hidden');
                     return;
                }

                const averages = markingElements.reduce((acc, el) => {
                    acc[el.key] = allDaysData.reduce((sum, day) => sum + (day[el.key] || 0), 0) / allDaysData.length;
                    return acc;
                }, {});

                const minMaxAnalysis = markingElements.map(el => {
                    if (el.key === 'score') return null; // Don't do min/max on score itself
                    const sorted = [...allDaysData].sort((a, b) => (a[el.key] || 0) - (b[el.key] || 0));
                    const min = sorted[0];
                    const max = sorted[sorted.length - 1];
                    return { ...el, min: { value: min[el.key], date: min.date }, max: { value: max[el.key], date: max.date } };
                }).filter(Boolean);
                
                reportHtml += `
                    <div class="bg-gray-100/60 p-4 rounded-lg text-center">
                        <p class="text-gray-600 font-semibold">Average Daily Score</p>
                        <p class="text-3xl font-bold text-blue-800">${averages.score.toFixed(1)} / 120</p>
                    </div>
                    <div>
                        <h4 class="font-bold text-gray-700 mb-2">Average Performance Breakdown</h4>
                         <div class="grid grid-cols-1 sm:grid-cols-2 gap-x-6 gap-y-3 text-xs">
                         ${markingElements.map(el => {
                            const value = averages[el.key] || 0;
                            const percentage = el.max > 0 ? (value / el.max) * 100 : 0;
                            const color = getProgressBarColor(percentage, el.good === 'high');
                            return `
                            <div class="space-y-1">
                                <div class="flex justify-between font-semibold"><p>${el.name}</p><p>${value.toFixed(1)} ${el.unit}</p></div>
                                <div class="w-full bg-gray-200 rounded-full h-2"><div class="${color} h-2 rounded-full" style="width: ${percentage}%"></div></div>
                            </div>`;
                        }).join('')}
                        </div>
                    </div>
                    <div>
                        <h4 class="font-bold text-gray-700 mb-2">Detailed Marking Log</h4>
                        <div class="max-h-48 overflow-y-auto overflow-x-auto custom-scrollbar border rounded-lg bg-white">
                            <table class="w-full text-xs whitespace-nowrap">
                                <thead class="bg-gray-200 sticky top-0"><tr class="text-left text-gray-600">
                                    <th class="p-2 font-semibold">Date</th>
                                    ${markingElements.map(el => `<th class="p-2 font-semibold text-center" title="${el.name}">${el.shortName}</th>`).join('')}
                                </tr></thead>
                                <tbody>
                                    ${allDaysData.map(day => `
                                        <tr class="border-t text-center">
                                            <td class="p-2 text-left font-semibold">${day.date}</td>
                                            ${markingElements.map(el => `<td class="p-2">${(day[el.key] || 0).toFixed(1)}</td>`).join('')}
                                        </tr>
                                    `).join('')}
                                </tbody>
                            </table>
                        </div>
                    </div>
                    <div>
                        <h4 class="font-bold text-gray-700 mb-2">Maximum & Minimum Analysis</h4>
                        <div class="max-h-48 overflow-y-auto overflow-x-auto custom-scrollbar border rounded-lg bg-white">
                             <table class="w-full text-xs text-center">
                                <thead class="bg-gray-200 sticky top-0"><tr class="text-gray-600"><th class="p-2 font-semibold text-left">Element</th><th class="p-2 font-semibold">Max Value</th><th class="p-2 font-semibold">Date</th><th class="p-2 font-semibold">Min Value</th><th class="p-2 font-semibold">Date</th></tr></thead>
                                <tbody>${minMaxAnalysis.map(el => `
                                    <tr class="border-t">
                                        <td class="p-2 text-left font-semibold">${el.name}</td>
                                        <td class="p-2 text-green-600 font-bold">${el.max.value.toFixed(1)} ${el.unit}</td><td class="p-2 text-gray-500">${el.max.date}</td>
                                        <td class="p-2 text-red-600 font-bold">${el.min.value.toFixed(1)} ${el.unit}</td><td class="p-2 text-gray-500">${el.min.date}</td>
                                    </tr>`).join('')}
                                </tbody>
                            </table>
                        </div>
                    </div>
                `;
            }

            reportHtml += `</main>
                <footer class="mt-6 pt-4 border-t-2 text-center text-xs text-gray-500">
                    <p>This report reflects your overall well-being and productivity based on recorded data.</p>
                    <p>ALL COPYRIGHT RESERVED BY MRS @ 2025</p>
                </footer>`;
            
            contentEl.innerHTML = reportHtml;
            modalContainer.classList.remove('hidden');
        };

        const generateComprehensiveWorkPlanReport = (startDate, endDate) => {
            const modalContainer = document.getElementById('comprehensive-report-modal');
             modalContainer.innerHTML = `
                <div class="bg-white rounded-xl shadow-2xl w-full max-w-4xl h-[95vh] flex flex-col">
                     <div class="p-4 border-b flex flex-wrap justify-between items-center gap-4 sticky top-0 bg-white z-20 rounded-t-xl">
                        <h2 class="text-xl font-bold text-gray-800">Work Plan Report</h2>
                        <div class="flex items-center gap-2 flex-wrap">
                            <button id="save-report-jpeg-new" class="bg-blue-500 text-white font-semibold py-2 px-4 rounded-lg text-sm flex items-center gap-2 hover:bg-blue-600"><i data-lucide="image" class="w-4 h-4"></i>Save as JPEG</button>
                            <button id="save-report-pdf-new" class="bg-red-500 text-white font-semibold py-2 px-4 rounded-lg text-sm flex items-center gap-2 hover:bg-red-600"><i data-lucide="file-text" class="w-4 h-4"></i>Save as PDF</button>
                            <button id="close-comprehensive-report-modal-new" class="bg-gray-500 text-white font-semibold p-2 rounded-full hover:bg-gray-600"><i data-lucide="x" class="w-5 h-5"></i></button>
                        </div>
                    </div>
                    <div id="report-scroll-container" class="flex-grow overflow-y-auto overflow-x-hidden p-4 sm:p-6 bg-gray-200">
                        <div id="a4-page-wrapper" class="a4-page-preview shadow-lg report-watermark-bg mx-auto">
                            <div id="comprehensive-report-content" class="space-y-4 relative z-10 bg-transparent text-xs"></div>
                        </div>
                    </div>
                </div>`;

            document.getElementById('close-comprehensive-report-modal-new').addEventListener('click', () => modalContainer.classList.add('hidden'));
            document.getElementById('save-report-jpeg-new').addEventListener('click', () => saveReport('jpeg'));
            document.getElementById('save-report-pdf-new').addEventListener('click', () => saveReport('pdf'));
            lucide.createIcons();
            
            const contentEl = document.getElementById('comprehensive-report-content');
            const userInfo = loadData('userInfo', {name: 'N/A', mobile: 'N/A'});

            // Always clear previous charts before generating a new report
            Object.values(chartInstances).forEach(chart => {
                if (chart) chart.destroy();
            });

            if (startDate === endDate) {
                // --- SINGLE DAY DETAILED REPORT ---
                const date = startDate;
                const tasksForDay = workPlanData[date] || [];
                const totalTasks = tasksForDay.length;
                const doneTasksCount = tasksForDay.filter(t => t.status === 'Done').length;
                const completionRate = totalTasks > 0 ? (doneTasksCount / totalTasks) * 100 : 0;

                contentEl.innerHTML = `
                    <header class="pb-4 mb-4 border-b">
                        <div class="flex flex-col sm:flex-row justify-between items-start gap-4">
                            <div><h2 class="text-xl font-bold text-green-800">DAILY WORK PLAN REPORT</h2><p class="text-xs text-gray-500" style="font-family: 'Orbitron', sans-serif;">TRACK ME</p></div>
                            <div class="text-left sm:text-right text-xs"><p class="font-semibold text-gray-700">Date</p><p class="text-gray-500">${date}</p></div>
                        </div>
                    </header>
                    
                    <main class="space-y-4">
                        <div class="grid grid-cols-3 gap-2 text-center">
                            <div class="bg-blue-50 p-2 rounded-lg"><p class="text-xs text-gray-600">Total Tasks</p><p class="font-bold text-lg text-blue-700">${totalTasks}</p></div>
                            <div class="bg-green-50 p-2 rounded-lg"><p class="text-xs text-gray-600">Tasks Done</p><p class="font-bold text-lg text-green-700">${doneTasksCount}</p></div>
                            <div class="bg-red-50 p-2 rounded-lg"><p class="text-xs text-gray-600">Completion</p><p class="font-bold text-lg text-red-700">${completionRate.toFixed(0)}%</p></div>
                        </div>

                        <div>
                            <h4 class="font-bold text-gray-700 mb-1 text-sm">Task Breakdown</h4>
                            <div class="max-h-[60vh] overflow-y-auto overflow-x-auto custom-scrollbar border rounded-lg bg-white">
                                <table class="w-full text-xs">
                                    <thead class="bg-gray-100 sticky top-0">
                                        <tr>
                                            <th class="p-2 font-semibold text-left">Time</th>
                                            <th class="p-2 font-semibold text-left">Task</th>
                                            <th class="p-2 font-semibold text-left">Category</th>
                                            <th class="p-2 font-semibold text-left">Priority</th>
                                            <th class="p-2 font-semibold text-left">Status</th>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        ${tasksForDay.length > 0 ? tasksForDay.sort((a,b) => (a.time || '00:00').localeCompare(b.time || '00:00')).map(task => `
                                            <tr class="border-t">
                                                <td class="p-2">${task.time || 'N/A'}</td>
                                                <td class="p-2 font-semibold">${task.name}</td>
                                                <td class="p-2">${(task.category || "").split(' ')[0]}</td>
                                                <td class="p-2">${task.priority}</td>
                                                <td class="p-2">${task.status}</td>
                                            </tr>
                                        `).join('') : '<tr><td colspan="5" class="text-center p-4 text-gray-500">No tasks planned for this day.</td></tr>'}
                                    </tbody>
                                </table>
                            </div>
                        </div>
                    </main>
                `;
            } else {
                // --- DATE RANGE SUMMARY REPORT ---
                let allTasksInRange = [];
                let currentDate = new Date(startDate);
                let endDateObj = new Date(endDate);
                
                while(currentDate <= endDateObj) {
                    const dateStr = currentDate.toISOString().slice(0, 10);
                    if (workPlanData[dateStr]) {
                        allTasksInRange.push(...workPlanData[dateStr].map(t => ({...t, date: dateStr})));
                    }
                    currentDate.setDate(currentDate.getDate() + 1);
                }

                const totalTasks = allTasksInRange.length;
                const doneTasks = allTasksInRange.filter(t => t.status === 'Done');
                const completionRate = totalTasks > 0 ? (doneTasks.length / totalTasks) * 100 : 0;
                const priorityAnalysis = allTasksInRange.reduce((acc, task) => {
                    acc[task.priority] = (acc[task.priority] || 0) + 1;
                    return acc;
                }, { High: 0, Medium: 0, Low: 0 });
                const categoryAnalysis = allTasksInRange.reduce((acc, task) => {
                    const cat = (task.category || 'Office / Work').includes('Personal') ? 'Personal / Home' : 'Office / Work';
                    acc[cat] = (acc[cat] || 0) + 1;
                    return acc;
                }, { 'Personal / Home': 0, 'Office / Work': 0 });
                const categoryBreakdown = doneTasks.reduce((acc, task) => {
                    const cat = task.category.includes('Personal') ? 'Personal / Home' : 'Office / Work';
                    acc[cat] = (acc[cat] || 0) + 1;
                    return acc;
                }, { 'Personal / Home': 0, 'Office / Work': 0 });
                const dailyCompletions = doneTasks.reduce((acc, task) => {
                    acc[task.date] = (acc[task.date] || 0) + 1;
                    return acc;
                }, {});
                const workDays = Object.entries(dailyCompletions);
                const maxWork = workDays.length > 0 ? workDays.reduce((max, day) => day[1] > max[1] ? day : max) : ['N/A', 0];
                const minWork = workDays.length > 0 ? workDays.reduce((min, day) => day[1] < min[1] ? day : min) : ['N/A', 0];
                const statusAnalysis = allTasksInRange.reduce((acc, task) => {
                    acc[task.status] = (acc[task.status] || 0) + 1;
                    return acc;
                }, {});
                const timeSegmentAnalysis = allTasksInRange.reduce((acc, task) => {
                    const segment = getSegmentFromTime(task.time);
                    acc[segment] = (acc[segment] || 0) + 1;
                    return acc;
                }, {});
                const busiestSegment = Object.keys(timeSegmentAnalysis).length > 0 ? Object.entries(timeSegmentAnalysis).reduce((a, b) => a[1] > b[1] ? a : b) : ['N/A', 0];
                const highPriorityTotal = priorityAnalysis['High'] || 0;
                const highPriorityCompleted = doneTasks.filter(t => t.priority === 'High').length;
                const highPriorityCompletionRate = highPriorityTotal > 0 ? (highPriorityCompleted / highPriorityTotal) * 100 : 100;
                let finalScore = (completionRate * 0.7) + (highPriorityCompletionRate * 0.3);

                const dailyReportData = {};
                let reportDateIterator = new Date(startDate);
                const reportEndDateObj = new Date(endDate);
                while(reportDateIterator <= reportEndDateObj) {
                    const dateStr = reportDateIterator.toISOString().slice(0, 10);
                    const tasksForDay = workPlanData[dateStr] || [];
                    if (tasksForDay.length > 0) {
                        const totalTasks = tasksForDay.length;
                        const doneTasksCount = tasksForDay.filter(t => t.status === 'Done').length;
                        const completionRate = totalTasks > 0 ? (doneTasksCount / totalTasks) * 100 : 0;
                        const categories = new Set(tasksForDay.map(t => t.category));
                        const priorities = new Set(tasksForDay.map(t => t.priority));
                        dailyReportData[dateStr] = {
                            totalTasks: totalTasks,
                            totalCategories: categories.size,
                            totalPriorities: priorities.size,
                            completionRate: completionRate.toFixed(1)
                        };
                    }
                    reportDateIterator.setDate(reportDateIterator.getDate() + 1);
                }

                contentEl.innerHTML = `
                    <header class="pb-4 mb-4 border-b">
                        <div class="flex flex-col sm:flex-row justify-between items-start gap-4">
                            <div><h2 class="text-xl font-bold text-green-800">COMPREHENSIVE WORK PLAN REPORT</h2><p class="text-xs text-gray-500" style="font-family: 'Orbitron', sans-serif;">TRACK ME</p></div>
                            <div class="text-left sm:text-right text-xs"><p class="font-semibold text-gray-700">Date Range</p><p class="text-gray-500">${startDate} to ${endDate}</p></div>
                        </div>
                    </header>
                    <main class="space-y-4">
                        <div class="grid grid-cols-3 gap-2 text-center">
                            <div class="bg-green-50 p-2 rounded-lg"><p class="text-xs text-gray-600">Completion Rate</p><p class="font-bold text-lg text-green-700">${completionRate.toFixed(1)}%</p></div>
                            <div class="bg-yellow-50 p-2 rounded-lg"><p class="text-xs text-gray-600">High Priority Done</p><p class="font-bold text-lg text-yellow-700">${highPriorityCompletionRate.toFixed(1)}%</p></div>
                            <div class="bg-red-50 p-2 rounded-lg"><p class="text-xs text-gray-600">Final Score</p><p class="font-bold text-lg text-red-700">${finalScore.toFixed(1)}/100</p></div>
                        </div>
                        <div>
                            <h4 class="font-bold text-gray-700 mb-1 text-sm">Dynamic Records Analysis</h4>
                            <div class="grid grid-cols-1 sm:grid-cols-2 gap-2 text-xs">
                                <div class="bg-gray-50 p-2 rounded-lg border"><strong>Most Productive Day:</strong> ${maxWork[0]} (${maxWork[1]} tasks)</div>
                                <div class="bg-gray-50 p-2 rounded-lg border"><strong>Least Productive Day:</strong> ${minWork[0]} (${minWork[1]} tasks)</div>
                                <div class="bg-gray-50 p-2 rounded-lg border"><strong>Primary Category Focus:</strong> ${Object.keys(categoryAnalysis).reduce((a, b) => categoryAnalysis[a] > categoryAnalysis[b] ? a : b, 'N/A')}</div>
                                <div class="bg-gray-50 p-2 rounded-lg border"><strong>Busiest Time of Day:</strong> ${busiestSegment[0]}</div>
                            </div>
                        </div>
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                            <div>
                                <h4 class="font-bold text-gray-700 mb-1 text-sm">Work Status Analysis</h4>
                                <div class="bg-gray-50 p-2 rounded-lg border text-xs">${Object.entries(statusAnalysis).map(([status, count]) => `<div class="flex justify-between"><span>${status}</span><span class="font-semibold">${count} (${totalTasks > 0 ? ((count/totalTasks)*100).toFixed(1) : 0}%)</span></div>`).join('')}</div>
                            </div>
                             <div>
                                <h4 class="font-bold text-gray-700 mb-1 text-sm">Priority & Category</h4>
                                     <div class="bg-gray-50 p-2 rounded-lg border text-xs">
                                    ${Object.entries(priorityAnalysis).map(([p, c]) => `<div class="flex justify-between"><span>${p} Priority Tasks</span><span class="font-semibold">${c}</span></div>`).join('')}
                                    ${Object.entries(categoryBreakdown).map(([c, count]) => `<div class="flex justify-between"><span>${c} (Done)</span><span class="font-semibold">${count}</span></div>`).join('')}
                                 </div>
                            </div>
                        </div>
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                            <div class="bg-white p-2 rounded-lg border"><canvas id="priority-pie-chart" class="w-full h-32"></canvas></div>
                            <div class="bg-white p-2 rounded-lg border"><canvas id="category-bar-chart" class="w-full h-32"></canvas></div>
                        </div>
                        <div>
                            <h4 class="font-bold text-gray-700 mb-1 text-sm">Daily Summary Report</h4>
                            <div class="max-h-40 overflow-y-auto overflow-x-auto custom-scrollbar border rounded-lg bg-white"><table class="w-full text-xs">
                                <thead class="bg-gray-100 sticky top-0"><tr>
                                    <th class="p-1 font-semibold text-left">Date</th>
                                    <th class="p-1 font-semibold text-center">Total Tasks</th>
                                    <th class="p-1 font-semibold text-center">Total Categories</th>
                                    <th class="p-1 font-semibold text-center">Total Priorities</th>
                                    <th class="p-1 font-semibold text-center">Completion Rate (%)</th>
                                </tr></thead>
                                <tbody>${Object.entries(dailyReportData).map(([date, data]) => `<tr>
                                    <td class="p-1 text-left">${date}</td>
                                    <td class="p-1 text-center">${data.totalTasks}</td>
                                    <td class="p-1 text-center">${data.totalCategories}</td>
                                    <td class="p-1 text-center">${data.totalPriorities}</td>
                                    <td class="p-1 text-center">${data.completionRate}</td>
                                </tr>`).join('')}</tbody>
                            </table></div>
                        </div>
                    </main>
                `;
                chartInstances.priority = new Chart(document.getElementById('priority-pie-chart').getContext('2d'), {
                    type: 'pie', data: { labels: ['High', 'Medium', 'Low'], datasets: [{ data: [priorityAnalysis.High, priorityAnalysis.Medium, priorityAnalysis.Low], backgroundColor: ['rgb(239, 68, 68)', 'rgb(245, 158, 11)', 'rgb(34, 197, 94)'] }] }
                });
                chartInstances.category = new Chart(document.getElementById('category-bar-chart').getContext('2d'), {
                    type: 'bar', data: { labels: ['Personal/Home', 'Office/Work'], datasets: [{ label: 'Completed Tasks', data: [categoryBreakdown['Personal / Home'], categoryBreakdown['Office / Work']], backgroundColor: ['rgb(34, 197, 94)', 'rgb(59, 130, 246)']}] }, options: { indexAxis: 'y' }
                });
            }

            modalContainer.classList.remove('hidden');
        };

        // --- Good Morning Modal Logic ---
        const showGoodMorningPopup = () => {
            const now = new Date();
            const todayStr = localDateToYYYYMMDD(now);
            const lastLogin = loadData('lastLoginDate', null);

            if (lastLogin === todayStr) {
                return; // Already shown today
            }
            
            const userInfo = loadData('userInfo', { name: 'User' });
            document.getElementById('gm-user-name').textContent = userInfo.name.split(' ')[0];
            document.getElementById('gm-today-date').textContent = now.toLocaleDateString('en-GB', { weekday: 'long', year: 'numeric', month: 'long', day: 'numeric' });
            
            const bodyEl = document.getElementById('gm-body');
            bodyEl.innerHTML = ''; // Clear previous content

            // 1. Source Balances
            const sources = ['BKash', 'Rocket', 'Nagad', 'Bank Acc.', 'Cash'];
            const sourceBalances = sources.reduce((acc, source) => ({ ...acc, [source]: 0 }), {});
            financeTransactions.forEach(t => {
                if (sources.includes(t.source)) {
                    sourceBalances[t.source] += parseFloat(t.amount || 0) * (t.type === 'income' ? 1 : -1);
                }
            });
            let balanceHtml = `<div class="gm-item" style="animation-delay: 0.1s;"><h3 class="font-bold text-lg mb-2 text-gray-700">Current Balances</h3><div class="grid grid-cols-2 md:grid-cols-3 lg:grid-cols-5 gap-3 text-center">`;
            sources.forEach(source => {
                balanceHtml += `<div class="bg-gray-100 p-3 rounded-lg"><p class="font-semibold text-sm text-gray-600">${source}</p><p class="font-bold text-xl ${sourceBalances[source] >= 0 ? 'text-gray-800' : 'text-red-600'}">${sourceBalances[source].toFixed(0)}</p></div>`;
            });
            balanceHtml += `</div></div>`;
            bodyEl.innerHTML += balanceHtml;

            // 2. Forecast Comparison
            const { start, end } = getWeekRange(todayDate);
            const weekForecast = financeForecasts.find(f => f.weekStart === start);
            const weekTransactions = financeTransactions.filter(t => t.date >= start && t.date <= end);
            const actualIncome = weekTransactions.filter(t => t.type === 'income').reduce((sum, t) => sum + parseFloat(t.amount || 0), 0);
            const actualExpense = weekTransactions.filter(t => t.type === 'expense').reduce((sum, t) => sum + parseFloat(t.amount || 0), 0);
            
            let forecastHtml = `<div class="gm-item" style="animation-delay: 0.2s;"><h3 class="font-bold text-lg mb-2 text-gray-700">Weekly Forecast vs. Actual</h3>`;
            if (weekForecast) {
                const incomePercent = weekForecast.cashIn > 0 ? (actualIncome / weekForecast.cashIn * 100) : 0;
                const expensePercent = weekForecast.expense > 0 ? (actualExpense / weekForecast.expense * 100) : 0;
                forecastHtml += `<div class="space-y-3 text-sm">
                    <div>
                        <div class="flex justify-between mb-1"><span class="font-semibold">Income</span><span>${actualIncome.toFixed(0)} / ${weekForecast.cashIn}</span></div>
                        <div class="w-full bg-gray-200 rounded-full h-2.5"><div class="bg-green-500 h-2.5 rounded-full" style="width: ${Math.min(100, incomePercent)}%"></div></div>
                    </div>
                    <div>
                        <div class="flex justify-between mb-1"><span class="font-semibold">Expense</span><span>${actualExpense.toFixed(0)} / ${weekForecast.expense}</span></div>
                        <div class="w-full bg-gray-200 rounded-full h-2.5"><div class="bg-red-500 h-2.5 rounded-full" style="width: ${Math.min(100, expensePercent)}%"></div></div>
                    </div>
                </div>`;
            } else {
                forecastHtml += `<p class="text-center text-gray-500 bg-gray-50 p-4 rounded-lg">No forecast set for this week.</p>`;
            }
            forecastHtml += `</div>`;
            bodyEl.innerHTML += forecastHtml;

            // 3. Monthly High/Low
            const { datesArray } = getMonthDateRange(todayDate);
            const monthTxs = financeTransactions.filter(t => datesArray.includes(t.date));
            const sourceTotals = sources.reduce((acc, source) => ({...acc, [source]: {income: 0, expense: 0}}), {});
            monthTxs.forEach(t => {
                if(sourceTotals[t.source]) {
                    sourceTotals[t.source][t.type] += parseFloat(t.amount || 0);
                }
            });
            const findSource = (type, compare) => {
                let result = { source: 'N/A', amount: compare === 'max' ? -1 : Infinity };
                Object.entries(sourceTotals).forEach(([source, data]) => {
                    if (compare === 'max' && data[type] > result.amount) result = { source, amount: data[type] };
                    if (compare === 'min' && data[type] > 0 && data[type] < result.amount) result = { source, amount: data[type] };
                });
                return result.source;
            };

            let monthlyHtml = `<div class="gm-item" style="animation-delay: 0.3s;"><h3 class="font-bold text-lg mb-2 text-gray-700">This Month's Finance Insights</h3>
            <div class="grid grid-cols-2 gap-3 text-sm">
                <div class="bg-green-50 p-3 rounded-lg"><p class="font-semibold text-green-800">Top Income Source</p><p class="text-lg font-bold">${findSource('income', 'max')}</p></div>
                <div class="bg-green-50 p-3 rounded-lg"><p class="font-semibold text-green-800">Lowest Income Source</p><p class="text-lg font-bold">${findSource('income', 'min')}</p></div>
                <div class="bg-red-50 p-3 rounded-lg"><p class="font-semibold text-red-800">Top Expense Source</p><p class="text-lg font-bold">${findSource('expense', 'max')}</p></div>
                <div class="bg-red-50 p-3 rounded-lg"><p class="font-semibold text-red-800">Lowest Expense Source</p><p class="text-lg font-bold">${findSource('expense', 'min')}</p></div>
            </div></div>`;
            bodyEl.innerHTML += monthlyHtml;

            // 4. Today's Tasks
            const todayTasks = workPlanData[todayStr] || [];
            let tasksHtml = `<div class="gm-item" style="animation-delay: 0.4s;"><h3 class="font-bold text-lg mb-2 text-gray-700">Today's Tasks (${todayTasks.length})</h3>`;
            if (todayTasks.length > 0) {
                tasksHtml += `<div class="max-h-28 overflow-y-auto custom-scrollbar space-y-2 pr-2">`;
                todayTasks.sort((a,b) => (a.time || '00:00').localeCompare(b.time || '00:00')).forEach(task => {
                    tasksHtml += `<div class="flex justify-between items-center text-sm bg-gray-50 p-2 rounded-md">
                        <div><p class="font-semibold">${task.name}</p><p class="text-xs text-gray-500">${task.category.split('/')[0].trim()}</p></div>
                        <span class="font-bold text-red-600">${task.time}</span>
                    </div>`;
                });
                tasksHtml += `</div>`;
            } else {
                 tasksHtml += `<p class="text-center text-gray-500 bg-gray-50 p-4 rounded-lg">No tasks scheduled for today. Enjoy your day!</p>`;
            }
            tasksHtml += `</div>`;
            bodyEl.innerHTML += tasksHtml;

            // 5. Last Day Score
            const yesterday = new Date(now);
            yesterday.setDate(yesterday.getDate() - 1);
            const yesterdayStr = localDateToYYYYMMDD(yesterday);
            const yesterdayScore = calculateDailyScore(yesterdayStr);
            let scoreHtml = `<div class="gm-item" style="animation-delay: 0.5s;"><h3 class="font-bold text-lg mb-2 text-gray-700">Yesterday's Performance</h3>`;
            if (yesterdayScore > 0) {
                scoreHtml += `<div class="text-center bg-blue-50 p-4 rounded-lg"><p class="text-4xl font-bold text-blue-700">${yesterdayScore}<span class="text-2xl">/120</span></p></div>`;
            } else {
                 scoreHtml += `<p class="text-center text-gray-500 bg-gray-50 p-4 rounded-lg">No score recorded for yesterday.</p>`;
            }
            scoreHtml += `</div>`;
            bodyEl.innerHTML += scoreHtml;
            
            document.getElementById('good-morning-modal').classList.remove('hidden');
            saveData('lastLoginDate', todayStr);
            lucide.createIcons();
        };

        // --- Initial Load ---
        const initApp = () => {
            setupModals();
            lucide.createIcons();
            selectedDateForSchedule = localDateToYYYYMMDD(todayDate);
            const today = selectedDateForSchedule;
            
            document.getElementById('transaction-date').value = today;
            forecastDatePicker.value = today;
            
            financeTransactions = loadData('financeTransactions');
            financeBorrowers = loadData('financeBorrowers');
            workPlanData = loadData('workPlanData', {});
            financeForecasts = loadData('financeForecasts').filter(f => f && f.weekStart && f.weekEnd);
            markingHistory = loadData('markingHistory', {});
            hourlyRecords = loadData('hourlyRecords', {});
            
            renderDashboardStatusList(selectedDateForSchedule);
            renderAppDashboard();
            renderTaskHealthDashboard();
            renderTransactionsForDate(today);
            renderBorrowers();
            updatePurposeDatalists();
            updateForecastWeekRange();
            renderForecasts();
            renderCalendar();
            
            const savedLogo = loadData('logo', null);
            if (savedLogo) {
                document.getElementById('logo-image').src = savedLogo;
                document.getElementById('logo-image').classList.remove('hidden');
                document.getElementById('upload-logo-button').style.display = 'none';
            }

            if (!loadData('userInfo', null)) {
                document.getElementById('user-info-modal').classList.add('hidden');
            }

            checkBorrowerCommitments();
            showGoodMorningPopup();
            
            // Start the reminder interval
            if (reminderInterval) clearInterval(reminderInterval);
            reminderInterval = setInterval(checkRecordReminder, 5 * 60 * 1000); // Check every 5 minutes
            checkRecordReminder(); // Initial check
            
            // Start the date change checker
            setInterval(checkForDateChange, 60 * 1000); // Check every minute
        };

        // --- Save Report Functionality ---
        const saveReport = async (format) => {
            const originalReportEl = document.getElementById('a4-page-wrapper');
            if (!originalReportEl) {
                console.error("Report element not found.");
                return;
            }

            // 1. Create a clone for off-screen rendering that can grow with content
            const reportClone = originalReportEl.cloneNode(true);
            reportClone.id = 'a4-clone-for-render';
            reportClone.className = 'is-rendering-clone report-watermark-bg';
            
            // NEW: Ensure all scrollable tables are fully expanded for the screenshot
            const scrollableTables = reportClone.querySelectorAll('.overflow-y-auto, .overflow-x-auto');
            scrollableTables.forEach(el => {
                el.classList.remove('overflow-y-auto', 'overflow-x-auto', 'max-h-40', 'max-h-48', 'max-h-60', 'max-h-[60vh]');
                el.style.maxHeight = 'none';
                el.style.height = 'auto';
                el.style.overflow = 'visible';
            });
            
            // NEW: Remove sticky positioning from table headers to prevent rendering bugs in the download.
            const tableHeaders = reportClone.querySelectorAll('thead');
            tableHeaders.forEach(th => {
                th.classList.remove('sticky', 'top-0');
            });
            
            document.body.appendChild(reportClone);
            
            const { jsPDF } = window.jspdf;
            
            try {
                // A brief delay to ensure the clone is in the DOM and styles are applied
                await new Promise(resolve => setTimeout(resolve, 50));

                // 2. Render the full-height, off-screen clone
                const canvas = await html2canvas(reportClone, { 
                    scale: 2, // Higher scale for better quality
                    backgroundColor: '#FFFFFF',
                    useCORS: true
                });

                // 3. Process the rendered canvas for download
                if (format === 'jpeg') {
                    // For JPEG, save the entire canvas as one (potentially long) image
                    const link = document.createElement('a');
                    link.download = 'personal bank statement.jpeg';
                    link.href = canvas.toDataURL('image/jpeg', 0.9);
                    link.click();
                } else if (format === 'pdf') {
                    // For PDF, split the long canvas across multiple A4 pages
                    const canvasWidth = canvas.width;
                    const canvasHeight = canvas.height;
                    
                    const pdf = new jsPDF({ orientation: 'p', unit: 'mm', format: 'a4' });
                    
                    const pdfWidth = pdf.internal.pageSize.getWidth();
                    const pdfHeight = pdf.internal.pageSize.getHeight();

                    const canvasAspectRatio = canvasHeight / canvasWidth;
                    const totalPDFHeight = pdfWidth * canvasAspectRatio;

                    let heightLeft = totalPDFHeight;
                    let position = 0;

                    // Add the first page
                    pdf.addImage(canvas, 'PNG', 0, position, pdfWidth, totalPDFHeight);
                    heightLeft -= pdfHeight;

                    // Add new pages if content is taller than one page
                    while (heightLeft > 0) {
                        position -= pdfHeight; // Move the canvas "up" for the next slice
                        pdf.addPage();
                        pdf.addImage(canvas, 'PNG', 0, position, pdfWidth, totalPDFHeight);
                        heightLeft -= pdfHeight;
                    }
                    pdf.save('personal bank statement.pdf');
                }
            } catch (error) {
                console.error('Error generating report:', error);
                alert('Could not generate the report. Please try again.');
            } finally {
                // 4. Clean up by removing the clone from the DOM
                if (document.body.contains(reportClone)) {
                    document.body.removeChild(reportClone);
                }
            }
        };

        // --- Dashboard Analysis Section Logic ---
        const getMonthDateRange = (date) => {
            const year = date.getFullYear();
            const month = date.getMonth();
            const firstDay = new Date(year, month, 1);
            const lastDay = new Date(year, month + 1, 0);
            const dates = [];
            for (let d = new Date(firstDay); d <= lastDay; d.setDate(d.getDate() + 1)) {
                dates.push(new Date(d).toISOString().split('T')[0]);
            }
            return {
                datesArray: dates,
                monthName: date.toLocaleString('default', { month: 'long' }),
                year: year
            };
        };

        const setupAnalysisTabs = () => {
            document.querySelectorAll('.analysis-tab').forEach(tab => {
                tab.addEventListener('click', (e) => {
                    const tabName = e.currentTarget.dataset.tab;
                    // Update tab styles
                    document.querySelectorAll('.analysis-tab').forEach(t => {
                        t.classList.remove('text-red-600', 'border-red-500');
                        t.classList.add('text-gray-500', 'border-transparent', 'hover:text-gray-700', 'hover:border-gray-300');
                    });
                    e.currentTarget.classList.add('text-red-600', 'border-red-500');
                    e.currentTarget.classList.remove('text-gray-500', 'border-transparent', 'hover:text-gray-700', 'hover:border-gray-300');
                    
                    // Show/hide content
                    document.querySelectorAll('.analysis-tab-content').forEach(c => c.classList.add('hidden'));
                    document.getElementById(`${tabName}-content`).classList.remove('hidden');
                });
            });

            document.getElementById('prev-month-btn').addEventListener('click', () => {
                analysisDate.setMonth(analysisDate.getMonth() - 1);
                renderDashboardAnalysis();
            });

            document.getElementById('next-month-btn').addEventListener('click', () => {
                analysisDate.setMonth(analysisDate.getMonth() + 1);
                renderDashboardAnalysis();
            });
        };

        const renderDashboardAnalysis = () => {
            const { monthName, year } = getMonthDateRange(analysisDate);
            document.getElementById('analysis-month-name').textContent = `${monthName} ${year}`;
            document.querySelectorAll('.analysis-month-label').forEach(el => el.textContent = monthName);

            renderFinanceSummary();
            renderWorkPlanInsights();
            renderHealthSummary();
            lucide.createIcons();
        };

        const renderFinanceSummary = () => {
            const { datesArray } = getMonthDateRange(analysisDate);
            const transactionsThisMonth = financeTransactions.filter(t => datesArray.includes(t.date));

            const totalIncome = transactionsThisMonth.filter(t => t.type === 'income').reduce((sum, t) => sum + parseFloat(t.amount || 0), 0);
            const totalExpense = transactionsThisMonth.filter(t => t.type === 'expense').reduce((sum, t) => sum + parseFloat(t.amount || 0), 0);

            document.getElementById('finance-summary-income').textContent = totalIncome.toFixed(2);
            document.getElementById('finance-summary-expense').textContent = totalExpense.toFixed(2);
            document.getElementById('finance-summary-net').textContent = (totalIncome - totalExpense).toFixed(2);

            const incomeByDay = datesArray.map(date => {
                return transactionsThisMonth.filter(t => t.date === date && t.type === 'income').reduce((sum, t) => sum + parseFloat(t.amount || 0), 0);
            });
            const expenseByDay = datesArray.map(date => {
                return transactionsThisMonth.filter(t => t.date === date && t.type === 'expense').reduce((sum, t) => sum + parseFloat(t.amount || 0), 0);
            });

            const chartData = {
                labels: datesArray.map(d => d.slice(8)), // Format as DD
                datasets: [
                    { label: 'Income', data: incomeByDay, borderColor: 'rgb(34, 197, 94)', backgroundColor: 'rgba(34, 197, 94, 0.5)', fill: true, tension: 0.1 },
                    { label: 'Expense', data: expenseByDay, borderColor: 'rgb(239, 68, 68)', backgroundColor: 'rgba(239, 68, 68, 0.5)', fill: true, tension: 0.1 }
                ]
            };

            if (chartInstances.finance) chartInstances.finance.destroy();
            chartInstances.finance = new Chart(document.getElementById('finance-line-chart').getContext('2d'), { type: 'line', data: chartData });
        };
        
        const renderWorkPlanInsights = () => {
            const { datesArray, monthName } = getMonthDateRange(analysisDate);
            const tasksThisMonth = datesArray.flatMap(date => workPlanData[date] || []);

            const totalTasks = tasksThisMonth.length;
            const completedTasks = tasksThisMonth.filter(t => t.status === 'Done').length;
            const completionRate = totalTasks > 0 ? (completedTasks / totalTasks) * 100 : 0;
            
            const tasksByDay = datesArray.reduce((acc, date) => {
                acc[date] = (workPlanData[date] || []).length;
                return acc;
            }, {});

            const busiestDay = Object.keys(tasksByDay).length > 0 ? Object.entries(tasksByDay).reduce((a, b) => a[1] > b[1] ? a : b)[0] : 'N/A';
            const dayOfWeek = busiestDay !== 'N/A' ? new Date(busiestDay).toLocaleDateString('en-US', { weekday: 'long' }) : 'N/A';

            document.getElementById('work-plan-summary-completion').textContent = `${completionRate.toFixed(0)}%`;
            document.getElementById('work-plan-summary-busiest').textContent = dayOfWeek;
            document.getElementById('work-plan-summary-total').textContent = totalTasks;

            // Bar Chart Data
            const plannedByDay = datesArray.map(date => (workPlanData[date] || []).length);
            const completedByDay = datesArray.map(date => (workPlanData[date] || []).filter(t => t.status === 'Done').length);
            const barChartData = {
                labels: datesArray.map(d => d.slice(8)), // Format as DD
                datasets: [
                    { label: 'Planned', data: plannedByDay, backgroundColor: 'rgba(167, 139, 250, 0.7)' },
                    { label: 'Completed', data: completedByDay, backgroundColor: 'rgba(99, 102, 241, 0.7)' }
                ]
            };
            if(chartInstances.workBar) chartInstances.workBar.destroy();
            chartInstances.workBar = new Chart(document.getElementById('work-plan-bar-chart').getContext('2d'), { type: 'bar', data: barChartData, options: { scales: { y: { beginAtZero: true } } } });

            // Doughnut Chart Data
            const officeTasks = tasksThisMonth.filter(t => (t.category || '').includes('Office')).length;
            const personalTasks = tasksThisMonth.filter(t => (t.category || '').includes('Personal')).length;
            const doughnutChartData = {
                labels: ['Office / Work', 'Personal / Home'],
                datasets: [{ data: [officeTasks, personalTasks], backgroundColor: ['rgb(59, 130, 246)', 'rgb(34, 197, 94)'] }]
            };
            if(chartInstances.workDoughnut) chartInstances.workDoughnut.destroy();
            chartInstances.workDoughnut = new Chart(document.getElementById('work-plan-doughnut-chart').getContext('2d'), { type: 'doughnut', data: doughnutChartData, options: { plugins: { title: { display: true, text: `Task Breakdown for ${monthName}` } } } });
        };
        
        const calculateDailyScoreForReport = (date) => {
            const manualData = markingHistory[date] || {};
            const hourlyData = hourlyRecords[date] || {};

            if (Object.keys(manualData).length === 0 && Object.keys(hourlyData).length === 0) {
                return null;
            }
            return calculateDailyScore(date);
        };
        
        const renderHealthSummary = () => {
             const { datesArray } = getMonthDateRange(analysisDate);
            
            const markingsThisMonth = datesArray.map(date => calculateDailyScoreForReport(date)).filter(score => score !== null);
            if (markingsThisMonth.length === 0) {
                document.getElementById('health-summary-avg-score').textContent = 'No Data';
                // Clear the chart if it exists
                if(chartInstances.healthRadar) chartInstances.healthRadar.destroy();
                chartInstances.healthRadar = null; // Prevent errors
                return;
            }

            const totalScore = markingsThisMonth.reduce((sum, score) => sum + score, 0);
            const avgScore = totalScore / markingsThisMonth.length;
            document.getElementById('health-summary-avg-score').textContent = `${avgScore.toFixed(1)} / 120`;

            const radarKeys = {
                'Sleep': { key: 'sleep', max: 8 }, 'Stress': { key: 'stress', max: 10, invert: true }, 'Mood': { key: 'mood', max: 10 },
                'Work': { key: 'work', max: 8 }, 'Workout': { key: 'workout', max: 0.5 }, 'Self-Ctrl': { key: 'selfControl', max: 10 }
            };
            
            const radarDataPoints = Object.entries(radarKeys).map(([label, {key, max, invert}]) => {
                let totalValue = 0;
                let count = 0;
                datesArray.forEach(date => {
                    const hourly = Object.values(hourlyRecords[date] || {});
                    hourly.forEach(rec => {
                         if(rec[key] !== undefined) {
                             totalValue += parseFloat(rec[key]) || 0;
                             count++;
                         }
                    });
                     // Include manual data if relevant
                    if (key === 'sleep' && markingHistory[date] && markingHistory[date].sleep) {
                        totalValue += parseFloat(markingHistory[date].sleep);
                        count++;
                    }
                });

                const avg = count > 0 ? totalValue / count : 0;
                let normalized = (avg / max) * 10;
                if(invert) normalized = 10 - normalized;
                return Math.min(10, Math.max(0, normalized)); // Clamp between 0 and 10
            });
            
            const radarChartData = {
                labels: Object.keys(radarKeys),
                datasets: [{
                    label: 'Health Balance',
                    data: radarDataPoints,
                    fill: true,
                    backgroundColor: 'rgba(239, 68, 68, 0.2)',
                    borderColor: 'rgb(239, 68, 68)',
                    pointBackgroundColor: 'rgb(239, 68, 68)',
                    pointBorderColor: '#fff',
                    pointHoverBackgroundColor: '#fff',
                    pointHoverBorderColor: 'rgb(239, 68, 68)'
                }]
            };

            if(chartInstances.healthRadar) chartInstances.healthRadar.destroy();
            chartInstances.healthRadar = new Chart(document.getElementById('health-radar-chart').getContext('2d'), { type: 'radar', data: radarChartData, options: { scales: { r: { beginAtZero: true, max: 10 } } } });
        };


        // --- Reset App Logic ---
        const deleteConfirmModal = document.getElementById('delete-confirm-modal');
        document.getElementById('reset-app-btn').addEventListener('click', () => {
            deleteConfirmModal.classList.remove('hidden');
        });

        document.getElementById('cancel-delete-btn').addEventListener('click', () => {
            deleteConfirmModal.classList.add('hidden');
        });

        document.getElementById('confirm-delete-btn').addEventListener('click', () => {
            localStorage.clear();
            deleteConfirmModal.classList.add('hidden');
            showToast('All data has been permanently deleted.');
            setTimeout(() => {
                location.reload();
            }, 1500); // Give user time to see the toast
        });
        
        initApp();
        renderDashboardAnalysis();
        setupAnalysisTabs();
    });
    </script>
</body>
</html>









